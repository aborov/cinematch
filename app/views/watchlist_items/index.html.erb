<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12 mb-4">
      <h1 class="display-4 text-center">My Watchlist</h1>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header unwatched-header">
          <h2 class="h4 mb-0">Unwatched</h2>
        </div>
        <div class="card-body unwatched-body" id="unwatched-list" data-controller="sortable" data-sortable-resource-url="/watchlist_items/">
          <%= render partial: 'watchlist_card', collection: @unwatched_items.compact, as: :item %>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header watched-header">
          <h2 class="h4 mb-0">Watched</h2>
        </div>
        <div class="card-body watched-body" id="watched-list" data-controller="sortable" data-sortable-resource-url="/watchlist_items/">
          <%= render partial: 'watchlist_card', collection: @watched_items.compact, as: :item %>
        </div>
      </div>
    </div>
  </div>
</div>

<%= render 'shared/details_modal' %>

<script>
  function handleWatchlistAction(action, sourceId, contentType, element) {
    let url, method;
    switch(action) {
      case 'markWatched':
        url = `/watchlist_items/${sourceId}/mark_watched?content_type=${contentType}`;
        method = 'PATCH';
        break;
      case 'markUnwatched':
        url = `/watchlist_items/${sourceId}/mark_unwatched?content_type=${contentType}`;
        method = 'PATCH';
        break;
      case 'removeItem':
        url = `/watchlist_items/${sourceId}?content_type=${contentType}`;
        method = 'DELETE';
        break;
    }
    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      if (data.status === 'success') {
        updateUI(action, element);
        updateWatchlistNavbar();
      } else {
        console.error('Error:', data.message);
        alert(data.message); // Show an alert to the user
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });
  }

  function updateUI(action, element) {
    const watchlistItem = element.closest('.watchlist-item');
    const sourceId = element.dataset.sourceId;
    const contentType = element.dataset.contentType;
    switch(action) {
      case 'markWatched':
      case 'markUnwatched':
        const targetList = action === 'markWatched' ? 
          document.querySelector('#watched-list') : 
          document.querySelector('#unwatched-list');
        if (targetList && watchlistItem) {
          watchlistItem.remove();
          targetList.appendChild(watchlistItem);
          updateButtonState(element, action === 'markWatched');
        }
        break;
      case 'removeItem':
        if (watchlistItem) {
          watchlistItem.remove();
        }
        break;
    }
  }

  function updateButtonState(button, isWatched) {
    button.innerHTML = isWatched ? 
      '<i class="fas fa-eye-slash me-1"></i>Unwatched' : 
      '<i class="fas fa-eye me-1"></i>Watched';
    button.classList.toggle('btn-warning', isWatched);
    button.classList.toggle('btn-success', !isWatched);
    button.classList.toggle('mark-unwatched', isWatched);
    button.classList.toggle('mark-watched', !isWatched);
  }

document.addEventListener('DOMContentLoaded', function() {
  document.addEventListener('click', function(event) {
    const button = event.target.closest('.mark-watched, .mark-unwatched, .remove-item');
    if (button) {
      event.preventDefault();
      const action = button.classList.contains('mark-watched') ? 'markWatched' :
                     button.classList.contains('mark-unwatched') ? 'markUnwatched' :
                     'removeItem';
      const sourceId = button.dataset.sourceId;
      const contentType = button.dataset.contentType;
      handleWatchlistAction(action, sourceId, contentType, button);
    }
  });

  document.querySelectorAll('.watchlist-item').forEach(card => {
    card.addEventListener('click', function(event) {
      if (!event.target.closest('.btn')) {
        const id = this.dataset.sourceId;
        const type = this.dataset.contentType;
        const watched = this.querySelector('.mark-unwatched') !== null;
        showDetails(id, type, watched);
      }
    });
  });

  // Add this new code for Sortable
  const unwatchedList = document.getElementById('unwatched-list');
  const watchedList = document.getElementById('watched-list');

  [unwatchedList, watchedList].forEach(list => {
    new Sortable(list, {
      animation: 150,
      ghostClass: 'blue-background-class',
      handle: '.drag-handle', // Add this line
      onEnd: function(evt) {
        const itemId = evt.item.getAttribute('data-id');
        const newIndex = evt.newIndex;
        const watched = evt.to.id === 'watched-list';

        updateItemPosition(itemId, newIndex, watched);
      }
    });
  });

  function updateItemPosition(itemId, newIndex, watched) {
    fetch(`/watchlist_items/${itemId}/update_position`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ position: newIndex, watched: watched })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        console.log('Position updated successfully');
      } else {
        console.error('Error updating position:', data.message);
      }
    })
    .catch(error => console.error('Error:', error));
  }
});

function showDetails(id, type, watched) {
  console.log('showDetails called with:', id, type, watched);
  fetch(`/recommendations/${id}?type=${type}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      console.log('Recommendation data received:', data);
      var country = data.production_countries ? data.production_countries.map(c => c.name === 'United States of America' ? 'USA' : c.name).join(', ') : 'N/A';
      return { ...data, inWatchlist: true, watched: watched, country: country };
    })
    .then(data => {
      const modalContent = generateModalContent(data);
      document.getElementById('popup-details').innerHTML = modalContent;
      new bootstrap.Modal(document.getElementById('detailsModal')).show();
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while fetching details. Please try again.');
    });
}

function generateModalContent(data) {
  var details = `
    <div class="row">
      <div class="col-md-4">
        <img src="https://image.tmdb.org/t/p/w500${data.poster_path}" class="img-fluid rounded" alt="${data.title || data.name} poster" role="img">
      </div>
      <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h2 class="text-warning mb-0">${data.title || data.name}</h2>
          <div class="d-flex flex-column align-items-end">
            <button class="btn btn-primary watchlist-toggle ${data.inWatchlist ? 'in-watchlist' : ''}" 
                    onclick="${data.inWatchlist ? `removeWatchlistItem(event, '${data.source_id}', '${data.content_type}')` : `toggleWatchlist(event, '${data.source_id}', '${data.content_type}')`}"
                    data-id="${data.id}"
                    data-source-id="${data.source_id}"
                    data-content-type="${data.content_type}"
                    aria-label="${data.inWatchlist ? 'Remove from Watchlist' : 'Add to Watchlist'}">
              <i class="fas fa-bookmark ${data.inWatchlist ? 'text-warning' : 'text-muted'}" 
                 alt="${data.inWatchlist ? 'Remove from Watchlist' : 'Add to Watchlist'}"></i>
              <span class="watchlist-text ms-1">${data.inWatchlist ? 'Remove' : 'Add'}</span>
            </button>
            ${data.inWatchlist ? `
              <button class="btn btn-outline-primary watched-toggle mt-2 ${data.watched ? 'watched' : ''}" 
                      onclick="toggleWatched(event, '${data.source_id}', '${data.content_type}')"
                      data-id="${data.id}"
                      data-source-id="${data.source_id}"
                      data-content-type="${data.content_type}"
                      aria-label="${data.watched ? 'Mark as Unwatched' : 'Mark as Watched'}">
                <i class="fas ${data.watched ? 'fa-eye-slash' : 'fa-eye'}" 
                   alt="${data.watched ? 'Mark as Unwatched' : 'Mark as Watched'}"></i>
                <span class="watched-text ms-1">${data.watched ? 'Mark as Unwatched' : 'Mark as Watched'}</span>
              </button>
            ` : ''}
          </div>
        </div>
        ${data.content_type === 'movie' ? 
          `<p><strong>Runtime:</strong> ${data.runtime || 'N/A'} minutes</p>` :
          `<p><strong>Number of Seasons:</strong> ${data.number_of_seasons || 'N/A'}</p>
           <p><strong>Number of Episodes:</strong> ${data.number_of_episodes || 'N/A'}</p>
           <p><strong>In Production:</strong> ${data.in_production ? 'Yes' : 'No'}</p>`
        }
        <p><strong>Release Year:</strong> ${(data.release_date || data.first_air_date || '').substring(0, 4)}</p>
        <p><strong>Country:</strong> ${data.country}</p>
        <p><strong>TMDb Rating:</strong> ${data.vote_average} (${data.vote_count} votes)</p> 
        <p><strong>Genres:</strong> ${(data.genres || []).map(g => typeof g === 'string' ? g : g.name).join(', ')}</p>
        <p><strong>Description:</strong> ${data.overview}</p>
        ${data.content_type === 'movie' ?
          `<p><strong>Director(s):</strong> ${(data.credits?.crew || []).filter(c => c.job === 'Director').map(d => d.name).join(', ') || 'N/A'}</p>` :
          `<p><strong>Creator(s):</strong> ${data.creators ? data.creators.join(', ') : 'N/A'}</p>`
        }
        <p><strong>Cast:</strong> ${(data.credits?.cast || []).slice(0, 5).map(c => c.name).join(', ') || 'N/A'}</p>
        <p><strong>Spoken Languages:</strong> ${(data.spoken_languages || []).map(l => l.name).join(', ') || 'N/A'}</p>
      </div>
    </div>
    <div class="embed-responsive embed-responsive-16by9 mb-3">
      ${data.trailer_url ? `
        <iframe class="embed-responsive-item" width="100%" height="315" src="${data.trailer_url.replace('watch?v=', 'embed/')}" allowfullscreen title="${data.title || data.name} trailer"></iframe>
      ` : '<p>No video available</p>'}
    </div>
  `;
  return details;
}

function updateWatchlistNavbar() {
  Promise.all([
    fetch('/watchlist_items/count').then(response => {
      if (!response.ok) throw new Error('Count fetch failed');
      return response.json();
    }),
    fetch('/watchlist_items/recent').then(response => {
      if (!response.ok) throw new Error('Recent fetch failed');
      return response.json();
    })
  ])
    .then(([countData, recentData]) => {
      const badge = document.querySelector('#watchlist-count');
      if (badge) {
        badge.textContent = countData.count;
        badge.style.display = countData.count > 0 ? 'inline-block' : 'none';
      }

      const dropdown = document.querySelector('#watchlist-dropdown');
      if (dropdown) {
        if (recentData.items && recentData.items.length > 0) {
          dropdown.innerHTML = recentData.items.map(item => `
            <li><a class="dropdown-item" href="/watchlist_items">
              <img src="${item.poster_url}" alt="${item.title}" class="me-2" style="width: 30px; height: 45px; object-fit: cover;">
              <span>${item.title} (${item.year})</span>
            </a></li>
          `).join('') + `
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-primary" href="/watchlist_items">View All</a></li>
          `;
        } else {
          dropdown.innerHTML = '<li><span class="dropdown-item">No items in watchlist</span></li>';
        }
      }
      console.log('Watchlist navbar updated successfully');
      console.log('Count data:', countData);
      console.log('Recent data:', recentData);
    })
    .catch(error => console.error('Error updating watchlist navbar:', error));
}

function toggleWatchlist(event, id, type) {
  event.preventDefault();
  event.stopPropagation();
  console.log('toggleWatchlist called');

  const button = event.currentTarget;
  const inWatchlist = !button.classList.contains('in-watchlist');
  const sourceId = button.dataset.sourceId;

  const method = inWatchlist ? 'POST' : 'DELETE';
  const url = inWatchlist ? '/watchlist_items' : `/watchlist_items/${sourceId}?content_type=${type}`;

  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    },
    body: JSON.stringify({ source_id: sourceId, content_type: type })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      console.log('Watchlist toggled:', data);
      updateWatchlistUI(sourceId, inWatchlist);
      updateWatchlistNavbar();
      if (inWatchlist && data.item) {
        createWatchlistCard(data.item);
      }
    } else {
      console.error('Error toggling watchlist:', data);
      updateWatchlistUI(sourceId, !inWatchlist);
    }
  })
  .catch(error => {
    console.error('Error toggling watchlist:', error);
    updateWatchlistUI(sourceId, !inWatchlist);
  });
}

function createWatchlistCard(item) {
  console.log('Creating watchlist card for item:', item);
  const targetList = item.watched ? document.getElementById('watched-list') : document.getElementById('unwatched-list');
  if (targetList) {
    const newCard = document.createElement('div');
    newCard.className = 'card mb-3 watchlist-item';
    newCard.setAttribute('data-id', item.id);
    newCard.setAttribute('data-source-id', item.source_id);
    newCard.setAttribute('data-content-type', item.content_type);
    newCard.setAttribute('role', 'article');
    newCard.setAttribute('aria-labelledby', `title-${item.source_id}`);

    newCard.innerHTML = `
      <div class="row g-0">
        <div class="col-4">
          <img src="${item.poster_url}" class="img-fluid rounded-start" alt="${item.title} poster">
        </div>
        <div class="col-8">
          <div class="card-body position-relative">
            <h5 class="card-title mb-1" id="title-${item.source_id}">${item.title}</h5>
            <div class="card-text small">
              ${[item.release_year, item.content_type.charAt(0).toUpperCase() + item.content_type.slice(1)].filter(Boolean).join(", ")}<br>
              <strong>TMDb:</strong> ${item.vote_average}<br>
              ${item.genres.join(", ")}
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <button class="btn btn-sm ${item.watched ? 'btn-warning mark-unwatched' : 'btn-success mark-watched'}" 
                      data-source-id="${item.source_id}" 
                      data-content-type="${item.content_type}">
                <i class="fas ${item.watched ? 'fa-eye-slash' : 'fa-eye'} me-1"></i>
                ${item.watched ? 'Unwatched' : 'Watched'}
              </button>
              <button class="btn btn-sm btn-danger remove-item" 
                      data-source-id="${item.source_id}" 
                      data-content-type="${item.content_type}">
                <i class="fas fa-trash-alt me-1"></i>
                Remove
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="drag-handle position-absolute top-0 start-0 p-2 text-white">
        <i class="fas fa-grip-vertical"></i>
      </div>
    `;

    targetList.appendChild(newCard);
    console.log('New card added to the DOM:', newCard);

    // Attach event listeners to the new card
    attachCardEventListeners(newCard);
  } else {
    console.error('Target list not found for item:', item);
  }
}

function attachCardEventListeners(card) {
  card.addEventListener('click', function(event) {
    if (!event.target.closest('.btn')) {
      const id = this.dataset.sourceId;
      const type = this.dataset.contentType;
      const watched = this.querySelector('.mark-unwatched') !== null;
      showDetails(id, type, watched);
    }
  });

  const watchButton = card.querySelector('.mark-watched, .mark-unwatched');
  const removeButton = card.querySelector('.remove-item');

  if (watchButton) {
    watchButton.addEventListener('click', function(event) {
      event.preventDefault();
      const action = this.classList.contains('mark-watched') ? 'markWatched' : 'markUnwatched';
      const sourceId = this.dataset.sourceId;
      const contentType = this.dataset.contentType;
      handleWatchlistAction(action, sourceId, contentType, this);
    });
  }

  if (removeButton) {
    removeButton.addEventListener('click', function(event) {
      event.preventDefault();
      const sourceId = this.dataset.sourceId;
      const contentType = this.dataset.contentType;
      handleWatchlistAction('removeItem', sourceId, contentType, this);
    });
  }
}

function updateWatchlistUI(sourceId, inWatchlist) {
  console.log('updateWatchlistUI called with:', sourceId, inWatchlist);
  
  const popupButton = document.querySelector(`#popup-details .watchlist-toggle[data-source-id="${sourceId}"]`);
  const card = document.querySelector(`.watchlist-item[data-source-id="${sourceId}"]`);

  if (popupButton) {
    console.log(`Updating button UI for popup with sourceId:`, sourceId);
    popupButton.classList.toggle('in-watchlist', inWatchlist);
    popupButton.innerHTML = `
      <i class="fas fa-bookmark ${inWatchlist ? 'text-warning' : 'text-muted'}" 
         alt="${inWatchlist ? 'Remove from Watchlist' : 'Add to Watchlist'}"></i>
      <span class="watchlist-text ms-1">${inWatchlist ? 'Remove' : 'Add'}</span>
    `;
    popupButton.setAttribute('aria-label', inWatchlist ? 'Remove from Watchlist' : 'Add to Watchlist');
    popupButton.setAttribute('onclick', `toggleWatchlist(event, '${sourceId}', '${popupButton.dataset.contentType}')`);
  }

  if (card && !inWatchlist) {
    console.log(`Removing card UI for sourceId:`, sourceId);
    card.remove();
  }
}

function toggleWatched(event, id, type) {
  event.preventDefault();
  event.stopPropagation();
  console.log('toggleWatched called');

  const button = event.currentTarget;
  const watched = !button.classList.contains('watched');
  const sourceId = button.dataset.sourceId;

  // Immediately update UI
  updateWatchedUI(sourceId, watched);

  const action = watched ? 'markWatched' : 'markUnwatched';
  handleWatchlistAction(action, sourceId, type, button);
}

function updateWatchedUI(sourceId, watched) {
  console.log('updateWatchedUI called with:', sourceId, watched);
  
  const popupButton = document.querySelector(`#popup-details .watched-toggle[data-source-id="${sourceId}"]`);
  const card = document.querySelector(`.watchlist-item[data-source-id="${sourceId}"]`);

  if (popupButton) {
    console.log(`Updating button UI for popup with sourceId:`, sourceId);
    popupButton.classList.toggle('watched', watched);
    popupButton.innerHTML = `
      <i class="fas ${watched ? 'fa-eye-slash' : 'fa-eye'}" 
         alt="${watched ? 'Mark as Unwatched' : 'Mark as Watched'}"></i>
      <span class="watched-text ms-1">${watched ? 'Mark as Unwatched' : 'Mark as Watched'}</span>
    `;
    popupButton.setAttribute('aria-label', watched ? 'Mark as Unwatched' : 'Mark as Watched');
  }

  if (card) {
    console.log(`Updating card UI for sourceId:`, sourceId);
    const watchButton = card.querySelector('.btn-success, .btn-warning');
    if (watchButton) {
      updateButtonState(watchButton, watched);
    }
    
    const sourceList = watched ? document.getElementById('unwatched-list') : document.getElementById('watched-list');
    const targetList = watched ? document.getElementById('watched-list') : document.getElementById('unwatched-list');
    if (sourceList && targetList && sourceList.contains(card)) {
      targetList.appendChild(card);
    }
  }
}

function removeWatchlistItem(event, sourceId, contentType) {
  event.preventDefault();
  event.stopPropagation();
  console.log('removeWatchlistItem called');

  // Immediately update UI
  updateWatchlistUI(sourceId, false);

  const url = `/watchlist_items/${sourceId}?content_type=${contentType}`;
  fetch(url, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      console.log('Item removed from watchlist:', data);
      updateWatchlistNavbar();
    } else {
      console.error('Error removing item from watchlist:', data);
      // Revert UI change if the server request failed
      updateWatchlistUI(sourceId, true);
    }
  })
  .catch(error => {
    console.error('Error removing item from watchlist:', error);
    // Revert UI change if there was a network error
    updateWatchlistUI(sourceId, true);
  });
}

document.addEventListener('click', function(event) {
  const button = event.target.closest('.mark-watched, .mark-unwatched, .remove-item');
  if (button) {
    event.preventDefault();
    const action = button.classList.contains('mark-watched') ? 'markWatched' :
                   button.classList.contains('mark-unwatched') ? 'markUnwatched' :
                   'removeItem';
    const sourceId = button.dataset.sourceId;
    const contentType = button.dataset.contentType;
    handleWatchlistAction(action, sourceId, contentType, button);
  }
});
</script>
