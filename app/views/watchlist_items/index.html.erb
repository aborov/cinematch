<h1 class="mb-4">My Watchlist</h1>

<div class="row">
  <div class="col-md-6">
    <h2>Unwatched</h2>
    <div data-controller="sortable" data-sortable-resource-url="/watchlist_items/" class="watchlist-container">
      <% @unwatched_items.each do |item| %>
        <div class="card mb-3 watchlist-item" data-content-id="<%= item.content.source_id %>">
          <div class="row g-0">
            <div class="col-md-4">
              <%= image_tag item.content.poster_url, alt: item.content.title, class: 'img-fluid rounded-start' %>
            </div>
            <div class="col-md-8">
              <div class="card-body">
                <h5 class="card-title"><%= item.content.title %></h5>
                <p class="card-text"><small class="text-muted"><%= item.content.release_year %> | <%= item.content.content_type.capitalize %></small></p>
                <button class="btn btn-sm btn-success mark-watched" data-content-id="<%= item.content.source_id %>">Mark as Watched</button>
                <button class="btn btn-sm btn-danger remove-item" data-content-id="<%= item.content.source_id %>">Remove</button>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="col-md-6">
    <h2>Watched</h2>
    <div class="watchlist-container">
      <% @watched_items.each do |item| %>
        <div class="card mb-3 watchlist-item" data-content-id="<%= item.content.source_id %>">
          <div class="row g-0">
            <div class="col-md-4">
              <%= image_tag item.content.poster_url, alt: item.content.title, class: 'img-fluid rounded-start' %>
            </div>
            <div class="col-md-8">
              <div class="card-body">
                <h5 class="card-title"><%= item.content.title %></h5>
                <p class="card-text"><small class="text-muted"><%= item.content.release_year %> | <%= item.content.content_type.capitalize %></small></p>
                <button class="btn btn-sm btn-warning mark-unwatched" data-content-id="<%= item.content.source_id %>">Mark as Unwatched</button>
                <button class="btn btn-sm btn-danger remove-item" data-content-id="<%= item.content.source_id %>">Remove</button>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  function handleWatchlistAction(action, contentId, element) {
    let url, method;
    switch(action) {
      case 'markWatched':
        url = `/watchlist_items/${contentId}/mark_watched`;
        method = 'PATCH';
        break;
      case 'markUnwatched':
        url = `/watchlist_items/${contentId}/mark_unwatched`;
        method = 'PATCH';
        break;
      case 'removeItem':
        url = `/watchlist_items/${contentId}`;
        method = 'DELETE';
        break;
    }

    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        updateUI(action, element);
        updateWatchlistNavbar();
      } else {
        console.error('Error updating watchlist item:', data);
      }
    })
    .catch(error => {
      console.error('Error updating watchlist item:', error);
    });
  }

  function updateUI(action, element) {
    const watchlistItem = element.closest('.watchlist-item');
    const contentId = element.dataset.contentId;
    switch(action) {
      case 'markWatched':
        watchlistItem.remove();
        document.querySelector('.col-md-6:nth-child(2) .watchlist-container').appendChild(watchlistItem);
        element.textContent = 'Mark as Unwatched';
        element.classList.remove('btn-success', 'mark-watched');
        element.classList.add('btn-warning', 'mark-unwatched');
        element.onclick = function() { handleWatchlistAction('markUnwatched', contentId, this); };
        break;
      case 'markUnwatched':
        watchlistItem.remove();
        document.querySelector('.col-md-6:nth-child(1) .watchlist-container').appendChild(watchlistItem);
        element.textContent = 'Mark as Watched';
        element.classList.remove('btn-warning', 'mark-unwatched');
        element.classList.add('btn-success', 'mark-watched');
        element.onclick = function() { handleWatchlistAction('markWatched', contentId, this); };
        break;
      case 'removeItem':
        watchlistItem.remove();
        break;
    }
  }

  document.querySelectorAll('.mark-watched, .mark-unwatched, .remove-item').forEach(button => {
    button.addEventListener('click', function(event) {
      event.preventDefault();
      const action = this.classList.contains('mark-watched') ? 'markWatched' :
                     this.classList.contains('mark-unwatched') ? 'markUnwatched' :
                     'removeItem';
      const contentId = this.dataset.contentId;
      handleWatchlistAction(action, contentId, this);
    });
  });
});

function updateWatchlistNavbar() {
  Promise.all([
    fetch('/watchlist_items/count').then(response => response.json()),
    fetch('/watchlist_items/recent').then(response => response.json())
  ])
    .then(([countData, recentData]) => {
      const badge = document.querySelector('#watchlist-count');
      if (badge) {
        badge.textContent = countData.count;
        badge.style.display = countData.count > 0 ? 'inline-block' : 'none';
      }

      const dropdown = document.querySelector('#watchlist-dropdown');
      if (dropdown) {
        if (recentData.items.length > 0) {
          dropdown.innerHTML = recentData.items.map(item => `
            <a class="dropdown-item" href="/watchlist_items">
              ${item.title} (${item.year})
            </a>
          `).join('');
        } else {
          dropdown.innerHTML = '<span class="dropdown-item">No items in watchlist</span>';
        }
      }
      console.log('Count data:', countData);
      console.log('Recent data:', recentData);
    })
    .catch(error => console.error('Error updating watchlist navbar:', error));
}
</script>
