<h1>Fetcher Service Management</h1>

<div class="panel">
  <div class="panel_contents">
    <h3>Fetcher Service URL</h3>
    <p><%= @fetcher_url || 'Not configured' %></p>
    
    <h3>Actions</h3>
    <div class="actions">
      <%= button_to "Wake Fetcher Service", admin_wake_fetcher_service_path, method: :post, class: "button" %>
    </div>
    
    <h3>Run Test Job</h3>
    <%= form_tag admin_test_job_fetcher_service_path, method: :post do %>
      <div class="form-group">
        <%= label_tag :provider, "Provider:" %>
        <%= select_tag :provider, options_for_select(FetchContentJob::PROVIDERS, 'tmdb') %>
      </div>
      
      <div class="form-group">
        <%= label_tag :batch_size, "Batch Size:" %>
        <%= number_field_tag :batch_size, 5, min: 1, max: 50 %>
      </div>
      
      <%= submit_tag "Run Test Job", class: "button" %>
    <% end %>
    
    <h3>Current Status</h3>
    <% if @fetcher_status.is_a?(Hash) && @fetcher_status['error'].present? %>
      <p class="error"><%= @fetcher_status['error'] %></p>
    <% else %>
      <table border="0" cellspacing="0" cellpadding="0">
        <thead>
          <tr>
            <th>Memory Usage</th>
            <th>Status</th>
            <th>Uptime</th>
            <th>Environment</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><%= @fetcher_status['memory_usage'] %> MB</td>
            <td><%= @fetcher_status['status'] %></td>
            <td><%= @fetcher_status['uptime'] %> minutes</td>
            <td><%= @fetcher_status['environment'] %></td>
          </tr>
        </tbody>
      </table>
      
      <h4>Providers</h4>
      <% if @fetcher_status['providers'].present? %>
        <table border="0" cellspacing="0" cellpadding="0">
          <thead>
            <tr>
              <th>Provider</th>
              <th>Last Run</th>
              <th>Status</th>
              <th>Movies Fetched</th>
            </tr>
          </thead>
          <tbody>
            <% @fetcher_status['providers'].each do |provider| %>
              <tr>
                <td><%= provider['provider'] %></td>
                <td><%= provider['last_run'] ? Time.parse(provider['last_run']).strftime("%Y-%m-%d %H:%M:%S") : 'Never' %></td>
                <td><%= provider['status'] %></td>
                <td><%= provider['movies_fetched'] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p>No provider data available</p>
      <% end %>
    <% end %>
    
    <h3>Pending Fetcher Jobs</h3>
    <% if @pending_jobs.present? %>
      <table border="0" cellspacing="0" cellpadding="0">
        <thead>
          <tr>
            <th>Job ID</th>
            <th>Job Class</th>
            <th>Queue</th>
            <th>Created At</th>
            <th>Arguments</th>
          </tr>
        </thead>
        <tbody>
          <% @pending_jobs.each do |job| %>
            <tr>
              <td><%= job.id %></td>
              <td><%= job.job_class %></td>
              <td><%= job.queue_name %></td>
              <td><%= job.created_at.strftime("%Y-%m-%d %H:%M:%S") %></td>
              <td><%= job.serialized_params.truncate(100) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No pending jobs</p>
    <% end %>
    
    <h3>Recent Fetcher Jobs</h3>
    <% if @recent_jobs.present? %>
      <table border="0" cellspacing="0" cellpadding="0">
        <thead>
          <tr>
            <th>Job ID</th>
            <th>Job Class</th>
            <th>Queue</th>
            <th>Performed At</th>
            <th>Finished At</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <% @recent_jobs.each do |job| %>
            <tr>
              <td><%= job.id %></td>
              <td><%= job.job_class %></td>
              <td><%= job.queue_name %></td>
              <td><%= job.performed_at&.strftime("%Y-%m-%d %H:%M:%S") %></td>
              <td><%= job.finished_at&.strftime("%Y-%m-%d %H:%M:%S") %></td>
              <td>
                <% if job.error.present? %>
                  <span class="error">Failed</span>
                <% elsif job.finished_at.present? %>
                  <span class="success">Completed</span>
                <% else %>
                  <span class="warning">Running</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No recent jobs</p>
    <% end %>
  </div>
</div>

<style>
  .form-group {
    margin-bottom: 15px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 5px;
  }
  
  .button {
    background-color: #5E6469;
    color: white;
    padding: 8px 12px;
    border: none;
    cursor: pointer;
    margin-right: 10px;
  }
  
  .actions {
    margin-bottom: 20px;
  }
  
  .error {
    color: red;
  }
  
  .success {
    color: green;
  }
  
  .warning {
    color: orange;
  }
</style> 
