<div class="good-job-dashboard">
  <div class="stats-panel">
    <h3>Job Statistics</h3>
    <div class="stats-grid">
      <div class="stat-box">
        <h4>Total Jobs</h4>
        <p><%= GoodJob::Job.count %></p>
      </div>
      <div class="stat-box">
        <h4>Last Content Fetch</h4>
        <p><%= GoodJob::Job.where(job_class: 'FetchContentJob').finished.maximum(:finished_at)&.strftime('%Y-%m-%d %H:%M:%S') || 'Never' %></p>
      </div>
      <div class="stat-box">
        <h4>Last Recommendations Update</h4>
        <p><%= GoodJob::Job.where(job_class: 'UpdateAllRecommendationsJob').finished.maximum(:finished_at)&.strftime('%Y-%m-%d %H:%M:%S') || 'Never' %></p>
      </div>
      <div class="stat-box">
        <h4>Users with Preferences</h4>
        <p><%= UserPreference.count %></p>
      </div>
      <div class="stat-box">
        <h4>Users with Recommendations</h4>
        <p><%= UserPreference.where.not(recommended_content_ids: []).count %></p>
      </div>
      <div class="stat-box">
        <h4>Job Runner Status</h4>
        <% if defined?(@job_runner_available) && @job_runner_available %>
          <p class="status-indicator available">Available</p>
          <%= link_to 'Check Status', admin_good_job_dashboard_check_job_runner_path, class: 'status-link' %>
        <% else %>
          <p class="status-indicator unavailable">Unavailable</p>
          <%= link_to 'Check Status', admin_good_job_dashboard_check_job_runner_path, class: 'status-link' %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="manual-jobs-panel">
    <h3>Manual Job Actions</h3>
    <div class="job-buttons">
      <div class="job-button-container">
        <h4>Fetch Content</h4>
        <p>Next scheduled: <%= @next_fetch_job&.scheduled_at&.strftime('%Y-%m-%d %H:%M:%S') || 'None' %></p>
        <% if policy(:page).run_fetch_content? %>
          <%= link_to 'Run Now', admin_good_job_dashboard_run_fetch_content_path, 
                      method: :post, 
                      class: 'job-button',
                      data: { confirm: 'Are you sure you want to start a content fetch job?' } %>
          <div class="job-sub-buttons">
            <% if policy(:page).run_fetch_new_content? %>
              <%= link_to 'Fetch New Only', admin_good_job_dashboard_run_fetch_new_content_path, 
                          method: :post, 
                          class: 'job-sub-button',
                          data: { confirm: 'Are you sure you want to fetch only new content?' } %>
            <% end %>
            <% if policy(:page).run_update_existing_content? %>
              <%= link_to 'Update Existing', admin_good_job_dashboard_run_update_existing_content_path, 
                          method: :post, 
                          class: 'job-sub-button',
                          data: { confirm: 'Are you sure you want to update existing content?' } %>
            <% end %>
            <% if policy(:page).run_fill_missing_content_details? %>
              <%= link_to 'Fill Missing', admin_good_job_dashboard_run_fill_missing_content_details_path, 
                          method: :post, 
                          class: 'job-sub-button',
                          data: { confirm: 'Are you sure you want to fill missing content details?' } %>
            <% end %>
          </div>
        <% end %>
      </div>
      
      <div class="job-button-container">
        <h4>Update Recommendations</h4>
        <p>Next scheduled: <%= @next_update_job&.scheduled_at&.strftime('%Y-%m-%d %H:%M:%S') || 'None' %></p>
        <% if policy(:page).run_update_recommendations? %>
          <%= link_to 'Run Now', admin_good_job_dashboard_run_update_recommendations_path, 
                      method: :post, 
                      class: 'job-button',
                      data: { confirm: 'Are you sure you want to update recommendations for all users?' } %>
        <% end %>
      </div>
      
      <div class="job-button-container">
        <h4>Fill Missing Details</h4>
        <p>Next scheduled: <%= @next_fill_details_job&.scheduled_at&.strftime('%Y-%m-%d %H:%M:%S') || 'None' %></p>
        <% if policy(:page).run_fill_missing_details? %>
          <%= link_to 'Run Now', admin_good_job_dashboard_run_fill_missing_details_path, 
                      method: :post, 
                      class: 'job-button',
                      data: { confirm: 'Are you sure you want to fill missing content details?' } %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="recent-jobs-panel">
    <h3>Recent Jobs</h3>
    <table class="jobs-table">
      <thead>
        <tr>
          <th>Job</th>
          <th>Queue</th>
          <th>Status</th>
          <th>Started At</th>
          <th>Duration</th>
          <th>Error</th>
          <th>Details</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @jobs.order(created_at: :desc).limit(20).each do |job| %>
          <tr class="<%= job.error.present? ? 'error' : '' %>">
            <td><%= job.job_class %></td>
            <td><%= job.queue_name %></td>
            <td><%= job_status(job) %></td>
            <td><%= job.performed_at&.strftime('%Y-%m-%d %H:%M:%S') %></td>
            <td><%= job.finished_at ? ((job.finished_at - job.performed_at).round(2) rescue nil) : nil %> sec</td>
            <td><%= truncate(job.error, length: 50) if job.error.present? %></td>
            <td>
              <% if job.error.present? %>
                <button class="toggle-error-btn" data-job-id="<%= job.id %>">View Error</button>
                <div id="error-<%= job.id %>" class="error-details" style="display: none;">
                  <pre><%= job.error %></pre>
                </div>
              <% end %>
              <% if job.serialized_params&.dig('arguments')&.first&.is_a?(Hash) %>
                <% args = job.serialized_params['arguments'].first %>
                <% args.except('_aj_symbol_keys').map do |key, value| %>
                  <%= "#{key}: #{value}" if value == true %><br>
                <% end %>
              <% end %>
            </td>
            <td>
              <% if can_delete_job? %>
                <%= link_to 'Delete', admin_good_job_dashboard_delete_job_path(id: job.id), 
                            method: :delete, 
                            class: 'delete-job-btn',
                            data: { confirm: 'Are you sure you want to delete this job from history?' } %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="content-stats-panel">
    <h3>Content Statistics</h3>
    <div class="stats-grid">
      <div class="stat-box">
        <h4>Total Content Items</h4>
        <p><%= Content.count %></p>
      </div>
      <div class="stat-box">
        <h4>Added Last 24h</h4>
        <p><%= Content.where('created_at > ?', 24.hours.ago).count %></p>
      </div>
      <div class="stat-box">
        <h4>Updated Last 24h</h4>
        <p><%= Content.where('updated_at > ?', 24.hours.ago).count %></p>
      </div>
    </div>
  </div>
</div>

<style>
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-box {
  background: #f5f5f5;
  padding: 1rem;
  border-radius: 4px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.jobs-table {
  width: 100%;
  border-collapse: collapse;
}

.jobs-table th, .jobs-table td {
  padding: 0.5rem;
  text-align: left;
  border-bottom: 1px solid #eee;
}

.error {
  background-color: #fff3f3;
}

.manual-jobs-panel {
  margin-bottom: 2rem;
}

.job-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-top: 1rem;
}

.job-button-container {
  background: #f9f9f9;
  padding: 1.5rem;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  text-align: center;
}

.job-button-container h4 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  color: #333;
  font-size: 1.2rem;
}

.job-button-container p {
  margin-bottom: 1rem;
  color: #666;
  font-size: 0.9rem;
}

.job-button {
  display: inline-block;
  padding: 0.7rem 1.4rem;
  background-color: #2271b1;
  color: white !important;
  border-radius: 4px;
  text-decoration: none;
  font-weight: 600;
  font-size: 1rem;
  transition: all 0.2s;
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.job-button:hover {
  background-color: #135e96;
  color: white !important;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transform: translateY(-1px);
}

.job-sub-buttons {
  margin-top: 1rem;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.5rem;
}

.job-sub-button {
  display: inline-block;
  padding: 0.5rem 0.9rem;
  background-color: #f8f8f8;
  color: #0366d6 !important;
  border-radius: 4px;
  text-decoration: none;
  font-size: 0.9rem;
  font-weight: 500;
  border: 1px solid #ddd;
  transition: all 0.2s;
}

.job-sub-button:hover {
  background-color: #f0f0f0;
  color: #0256b9 !important;
  border-color: #bbb;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.toggle-error-btn {
  background-color: #f0f0f0;
  border: 1px solid #ddd;
  border-radius: 3px;
  padding: 3px 8px;
  font-size: 0.8rem;
  cursor: pointer;
}

.toggle-error-btn:hover {
  background-color: #e0e0e0;
}

.error-details {
  margin-top: 5px;
  padding: 8px;
  background-color: #f8f8f8;
  border: 1px solid #ddd;
  border-radius: 3px;
  max-height: 200px;
  overflow-y: auto;
}

.error-details pre {
  margin: 0;
  white-space: pre-wrap;
  font-size: 0.8rem;
}

.delete-job-btn {
  display: inline-block;
  padding: 3px 8px;
  background-color: #f8d7da;
  color: #721c24 !important;
  border-radius: 3px;
  text-decoration: none;
  font-size: 0.8rem;
  border: 1px solid #f5c6cb;
  transition: all 0.2s;
}

.delete-job-btn:hover {
  background-color: #f1b0b7;
  color: #721c24 !important;
  border-color: #f1b0b7;
}

.status-indicator {
  font-weight: bold;
  padding: 3px 8px;
  border-radius: 4px;
  display: inline-block;
  margin-bottom: 5px;
}

.status-indicator.available {
  background-color: #e8f5e9;
  color: #2e7d32;
}

.status-indicator.unavailable {
  background-color: #ffebee;
  color: #c62828;
}

.status-link {
  display: block;
  font-size: 0.9rem;
  color: #0366d6;
  text-decoration: underline;
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.toggle-error-btn').forEach(function(button) {
      button.addEventListener('click', function() {
        var jobId = this.getAttribute('data-job-id');
        var errorDiv = document.getElementById('error-' + jobId);
        if (errorDiv.style.display === 'none') {
          errorDiv.style.display = 'block';
          this.textContent = 'Hide Error';
        } else {
          errorDiv.style.display = 'none';
          this.textContent = 'View Error';
        }
      });
    });
  });
</script>
