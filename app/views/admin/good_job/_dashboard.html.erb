<%# Good Job Dashboard - Styles are in app/assets/stylesheets/admin/good_job_dashboard.scss %>
<div class="good-job-dashboard">
  <div class="stats-panel">
    <h3>Job Statistics</h3>
    <div class="stats-grid">
      <div class="stat-box">
        <h4>Total Jobs</h4>
        <p><%= GoodJob::Job.count %></p>
      </div>
      <div class="stat-box">
        <h4>Last Content Fetch</h4>
        <p><%= GoodJob::Job.where(job_class: 'FetchContentJob').finished.maximum(:finished_at)&.strftime('%Y-%m-%d %H:%M:%S') || 'Never' %></p>
      </div>
      <div class="stat-box">
        <h4>Last Recommendations Update</h4>
        <p><%= GoodJob::Job.where(job_class: 'UpdateAllRecommendationsJob').finished.maximum(:finished_at)&.strftime('%Y-%m-%d %H:%M:%S') || 'Never' %></p>
      </div>
      <div class="stat-box">
        <h4>Users with Preferences</h4>
        <p><%= UserPreference.count %></p>
      </div>
      <div class="stat-box">
        <h4>Users with Recommendations</h4>
        <p><%= UserPreference.where.not(recommended_content_ids: []).count %></p>
      </div>
      <div class="stat-box">
        <h4>Job Runner Status</h4>
        <% if defined?(@job_runner_available) && @job_runner_available %>
          <p class="status-indicator available">Available</p>
          <%= link_to 'Check Status', admin_good_job_dashboard_check_job_runner_path, class: 'status-link' %>
        <% else %>
          <p class="status-indicator unavailable">Unavailable</p>
          <%= link_to 'Check Status', admin_good_job_dashboard_check_job_runner_path, class: 'status-link' %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="manual-jobs-panel">
    <h3>Manual Job Actions</h3>
    <div class="job-buttons">
      <div class="job-button-container">
        <h4>Fetch Content</h4>
        <p>Next scheduled: <%= @next_fetch_job&.scheduled_at&.strftime('%Y-%m-%d %H:%M:%S') || 'None' %></p>
        <% if policy(:page).run_fetch_content? %>
          <%= link_to 'Run Now', admin_good_job_dashboard_run_fetch_content_path, 
                      method: :post, 
                      class: 'job-button',
                      data: { confirm: 'Are you sure you want to start a content fetch job?' } %>
          <div class="job-sub-buttons">
            <% if policy(:page).run_fetch_new_content? %>
              <%= link_to 'Fetch New Only', admin_good_job_dashboard_run_fetch_new_content_path, 
                          method: :post, 
                          class: 'job-sub-button',
                          data: { confirm: 'Are you sure you want to fetch only new content?' } %>
            <% end %>
            <% if policy(:page).run_update_existing_content? %>
              <%= link_to 'Update Existing', admin_good_job_dashboard_run_update_existing_content_path, 
                          method: :post, 
                          class: 'job-sub-button',
                          data: { confirm: 'Are you sure you want to update existing content?' } %>
            <% end %>
            <% if policy(:page).run_fill_missing_content_details? %>
              <%= link_to 'Fill Missing', admin_good_job_dashboard_run_fill_missing_content_details_path, 
                          method: :post, 
                          class: 'job-sub-button',
                          data: { confirm: 'Are you sure you want to fill missing content details?' } %>
            <% end %>
          </div>
        <% end %>
      </div>
      
      <div class="job-button-container">
        <h4>Update Recommendations</h4>
        <p>Next scheduled: <%= @next_update_job&.scheduled_at&.strftime('%Y-%m-%d %H:%M:%S') || 'None' %></p>
        <% if policy(:page).run_update_recommendations? %>
          <%= form_tag admin_good_job_dashboard_run_update_recommendations_path, method: :post, class: 'job-form' do %>
            <div class="form-group">
              <%= label_tag :batch_size, 'Batch Size:' %>
              <%= number_field_tag :batch_size, 50, min: 10, max: 200, class: 'form-control' %>
            </div>
            <%= submit_tag 'Run Now', 
                        class: 'job-button',
                        data: { confirm: 'Are you sure you want to update recommendations for all users?' } %>
          <% end %>
        <% end %>
      </div>
      
      <div class="job-button-container">
        <h4>Fill Missing Details</h4>
        <p>Next scheduled: <%= @next_fill_details_job&.scheduled_at&.strftime('%Y-%m-%d %H:%M:%S') || 'None' %></p>
        <% if policy(:page).run_fill_missing_details? %>
          <%= link_to 'Run Now', admin_good_job_dashboard_run_fill_missing_details_path, 
                      method: :post, 
                      class: 'job-button',
                      data: { confirm: 'Are you sure you want to fill missing content details?' } %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="recent-jobs-panel">
    <h3>Recent Jobs</h3>
    <div class="refresh-controls">
      <a href="<%= admin_good_job_dashboard_path %>" class="refresh-button">Refresh Job List</a>
    </div>
    <table class="jobs-table">
      <thead>
        <tr>
          <th>Job</th>
          <th>Queue</th>
          <th>Status</th>
          <th>Started At</th>
          <th>Duration</th>
          <th>Error</th>
          <th>Details</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @jobs.order(created_at: :desc).limit(20).each do |job| %>
          <tr class="<%= job.error.present? ? 'error' : '' %>">
            <td><%= job_display_name(job) %></td>
            <td><%= job.queue_name %></td>
            <td><%= job_status(job) %></td>
            <td><%= job.performed_at&.strftime('%Y-%m-%d %H:%M:%S') %></td>
            <td><%= job.finished_at ? ((job.finished_at - job.performed_at).round(2) rescue nil) : nil %> sec</td>
            <td><%= truncate(job.error, length: 50) if job.error.present? %></td>
            <td>
              <% if job.error.present? %>
                <button class="toggle-error-btn" data-job-id="<%= job.id %>">View Error</button>
                <div id="error-<%= job.id %>" class="error-details hidden">
                  <pre><%= job.error %></pre>
                </div>
              <% end %>
              <% 
                begin
                  params_hash = if job.serialized_params.is_a?(Hash)
                    job.serialized_params
                  else
                    JSON.parse(job.serialized_params || '{}')
                  end
                  
                  if params_hash&.dig('arguments')
                    arguments = params_hash['arguments']
                    
                    # Handle different argument formats
                    args = if arguments.is_a?(Array) && !arguments.empty?
                      first_arg = arguments.first
                      
                      # Handle the case where the first argument is a string
                      if first_arg.is_a?(String)
                        # Try to parse it as JSON if it looks like a JSON string
                        if first_arg.start_with?('{') && first_arg.end_with?('}')
                          begin
                            JSON.parse(first_arg)
                          rescue
                            # If parsing fails, create a simple hash with the string
                            { 'argument' => first_arg }
                          end
                        else
                          # Not JSON, create a simple hash
                          { 'argument' => first_arg }
                        end
                      else
                        # Use the first argument as is
                        first_arg || {}
                      end
                    else
                      # If arguments is not an array or is empty, use an empty hash
                      {}
                    end
                    
                    if args.is_a?(Hash)
                      args.except('_aj_symbol_keys').map do |key, value|
              %>
                    <%= "#{key}: #{value}" if value == true %><br>
              <%
                      end
                    end
                  end
                rescue => e
                  # Silently handle parsing errors
                end
              %>
            </td>
            <td>
              <% if can_delete_job? %>
                <%= link_to 'Delete', admin_good_job_dashboard_delete_job_path(id: job.id), 
                            method: :delete, 
                            class: 'delete-job-btn',
                            data: { confirm: 'Are you sure you want to delete this job from history?' } %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="content-stats-panel">
    <h3>Content Statistics</h3>
    <div class="stats-grid">
      <div class="stat-box">
        <h4>Total Content Items</h4>
        <p><%= Content.count %></p>
      </div>
      <div class="stat-box">
        <h4>Added Last 24h</h4>
        <p><%= Content.where('created_at > ?', 24.hours.ago).count %></p>
      </div>
      <div class="stat-box">
        <h4>Updated Last 24h</h4>
        <p><%= Content.where('updated_at > ?', 24.hours.ago).count %></p>
      </div>
    </div>
  </div>
</div>
