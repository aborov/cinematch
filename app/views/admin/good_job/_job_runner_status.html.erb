<%# Job runner status display %>
<div class="status-box status-<%= @job_runner_status[:status] %>">
  <p><%= @job_runner_status[:message] %></p>
  
  <% if @job_runner_status[:is_job_runner] %>
    <%# Show job runner instance stats %>
    <div class="stats-grid">
      <div class="stat-box">
        <h4>Active Jobs</h4>
        <p><%= @job_runner_status[:active_jobs] %></p>
      </div>
      <div class="stat-box">
        <h4>Queued Jobs</h4>
        <p><%= @job_runner_status[:queued_jobs] %></p>
      </div>
    </div>
    
    <% if @job_runner_status[:recent_errors].present? && @job_runner_status[:recent_errors].any? %>
      <h4>Recent Errors</h4>
      <table class="jobs-table">
        <thead>
          <tr>
            <th>Job</th>
            <th>Error</th>
          </tr>
        </thead>
        <tbody>
          <% @job_runner_status[:recent_errors].each do |job| %>
            <tr>
              <td><%= job.job_class %></td>
              <td><%= job.error.to_s.truncate(100) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
    
  <% elsif @job_runner_status[:is_available] %>
    <%# Show available job runner stats %>
    <% if @job_runner_status[:details].present? %>
      <div class="stats-grid">
        <div class="stat-box">
          <h4>Environment</h4>
          <p><%= @job_runner_status[:details]['environment'] %></p>
        </div>
        <div class="stat-box">
          <h4>Timestamp</h4>
          <p><%= Time.parse(@job_runner_status[:details]['timestamp']).strftime("%Y-%m-%d %H:%M:%S") rescue @job_runner_status[:details]['timestamp'] %></p>
        </div>
        <div class="stat-box">
          <h4>Good Job Status</h4>
          <p><%= @job_runner_status[:details]['good_job_status'] %></p>
        </div>
        <% if @job_runner_status[:details]['active_jobs'].present? %>
          <div class="stat-box">
            <h4>Active Jobs</h4>
            <p><%= @job_runner_status[:details]['active_jobs'] %></p>
          </div>
          <div class="stat-box">
            <h4>Queued Jobs</h4>
            <p><%= @job_runner_status[:details]['queued_jobs'] %></p>
          </div>
        <% end %>
      </div>
      
      <% if @job_runner_status[:details]['recent_errors'].present? && @job_runner_status[:details]['recent_errors'].any? %>
        <h4>Recent Errors</h4>
        <table class="jobs-table">
          <thead>
            <tr>
              <th>Job</th>
              <th>Error</th>
            </tr>
          </thead>
          <tbody>
            <% @job_runner_status[:details]['recent_errors'].each do |error| %>
              <tr>
                <td><%= error['job_class'] %></td>
                <td><%= error['error'] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    <% end %>
    
    <% if @job_runner_status[:details_error].present? %>
      <div class="error-message">
        <p><%= @job_runner_status[:details_error] %></p>
      </div>
    <% end %>
  <% end %>
</div>

<%# Refresh button and auto-update %>
<div class="refresh-controls">
  <button id="refresh-job-runner-status" class="refresh-button">Refresh Status</button>
  <span class="auto-refresh-indicator">Auto-refreshes every 30 seconds</span>
</div>

<%# Inline JavaScript for job runner status updates %>
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    const refreshButton = document.getElementById('refresh-job-runner-status');
    const container = document.getElementById('job-runner-status-container');
    
    if (refreshButton && container) {
      refreshButton.addEventListener('click', function() {
        // Show loading indicator
        const statusContent = container.querySelector('.status-box');
        const refreshControls = container.querySelector('.refresh-controls');
        
        if (statusContent) {
          statusContent.innerHTML = '<p>Checking job runner status...</p>';
          statusContent.className = 'status-box status-checking';
        }
        
        // Fetch updated status
        fetch('/admin/good_job_dashboard/check_job_runner', {
          headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
          }
        })
        .then(response => response.text())
        .then(html => {
          // Replace only the content inside the container, not the entire container
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = html;
          
          // Extract the status box and refresh controls from the response
          const newStatusContent = tempDiv.querySelector('.status-box');
          const newRefreshControls = tempDiv.querySelector('.refresh-controls');
          
          if (newStatusContent && container) {
            // Replace just the status box
            if (statusContent) {
              statusContent.replaceWith(newStatusContent);
            } else {
              container.insertBefore(newStatusContent, refreshControls || null);
            }
          }
        })
        .catch(error => {
          if (statusContent) {
            statusContent.innerHTML = '<p>Error updating job runner status</p>';
            statusContent.className = 'status-box status-error';
          }
        });
      });
      
      // Auto-refresh every 30 seconds
      setInterval(function() {
        refreshButton.click();
      }, 30000);
    }
  });
</script> 
