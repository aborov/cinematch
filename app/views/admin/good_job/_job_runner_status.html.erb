<%# Job runner status display %>
<div class="status-box status-<%= @job_runner_status[:status] %>" data-last-updated="<%= Time.now.to_i %>">
  <p><%= @job_runner_status[:message] %></p>
  
  <% if @job_runner_status[:is_job_runner] %>
    <%# Show job runner instance stats %>
    <div class="stats-grid">
      <div class="stat-box">
        <h4>Environment</h4>
        <p><%= Rails.env %></p>
      </div>
      <div class="stat-box">
        <h4>Active Jobs</h4>
        <p><%= @job_runner_status[:active_jobs] %></p>
      </div>
      <div class="stat-box">
        <h4>Queued Jobs</h4>
        <p><%= @job_runner_status[:queued_jobs] %></p>
      </div>
    </div>
    
    <% if @job_runner_status[:recent_errors].present? && @job_runner_status[:recent_errors].any? %>
      <h4>Recent Errors</h4>
      <table class="jobs-table">
        <thead>
          <tr>
            <th>Job</th>
            <th>Error</th>
          </tr>
        </thead>
        <tbody>
          <% @job_runner_status[:recent_errors].each do |job| %>
            <tr>
              <td><%= job.respond_to?(:job_class) ? job.job_class : (job['job_class'] || job[:job_class]) %></td>
              <td><%= 
                if job.respond_to?(:error)
                  job.error.to_s.truncate(100)
                else
                  (job['error'] || job[:error]).to_s.truncate(100)
                end
              %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
    
  <% elsif @job_runner_status[:is_available] %>
    <%# Show available job runner stats %>
    <% if @job_runner_status[:details].present? %>
      <div class="stats-grid">
        <div class="stat-box">
          <h4>Environment</h4>
          <p><%= @job_runner_status[:details]['environment'] || @job_runner_status[:details][:environment] %></p>
        </div>
        <div class="stat-box">
          <h4>Timestamp</h4>
          <% 
            timestamp = @job_runner_status[:details]['timestamp'] || @job_runner_status[:details][:timestamp]
            formatted_timestamp = if timestamp.is_a?(String)
              begin
                Time.parse(timestamp).strftime("%Y-%m-%d %H:%M:%S")
              rescue
                timestamp
              end
            elsif timestamp.respond_to?(:strftime)
              timestamp.strftime("%Y-%m-%d %H:%M:%S")
            else
              timestamp.to_s
            end
          %>
          <p><%= formatted_timestamp %></p>
        </div>
        <div class="stat-box">
          <h4>Good Job Status</h4>
          <p><%= @job_runner_status[:details]['good_job_status'] || @job_runner_status[:details][:good_job_status] %></p>
        </div>
        <% 
          active_jobs = @job_runner_status[:details]['active_jobs'] || @job_runner_status[:details][:active_jobs]
          queued_jobs = @job_runner_status[:details]['queued_jobs'] || @job_runner_status[:details][:queued_jobs]
        %>
        <% if active_jobs.present? %>
          <div class="stat-box">
            <h4>Active Jobs</h4>
            <p><%= active_jobs %></p>
          </div>
          <div class="stat-box">
            <h4>Queued Jobs</h4>
            <p><%= queued_jobs %></p>
          </div>
        <% end %>
      </div>
      
      <% 
        recent_errors = @job_runner_status[:details]['recent_errors'] || @job_runner_status[:details][:recent_errors]
      %>
      <% if recent_errors.present? && recent_errors.any? %>
        <h4>Recent Errors</h4>
        <table class="jobs-table">
          <thead>
            <tr>
              <th>Job</th>
              <th>Error</th>
            </tr>
          </thead>
          <tbody>
            <% recent_errors.each do |error| %>
              <tr>
                <td><%= error['job_class'] || error[:job_class] %></td>
                <td><%= error['error'] || error[:error] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    <% end %>
    
    <% if @job_runner_status[:details_error].present? %>
      <div class="error-message">
        <p><%= @job_runner_status[:details_error] %></p>
      </div>
    <% end %>
  <% end %>
</div>

<%# Refresh button and auto-update %>
<div class="refresh-controls">
  <button id="refresh-job-runner-status" class="refresh-button">Refresh Status</button>
  <span class="auto-refresh-indicator">Auto-refreshes every 30 seconds</span>
</div> 
