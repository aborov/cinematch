<% content_for :title, "Your Profile Dashboard" %>
<% content_for :h1, "Your Profile Dashboard" %>
<div class="container-fluid d-flex justify-content-center align-items-center" style="min-height: calc(100vh - 200px);">
  <div class="card w-100" style="max-width: 800px;">
    <div class="card-header">
      <h2 class="mb-0">Your Profile</h2>
    </div>
    <div class="card-body p-0">
      <div class="accordion w-100" id="profileAccordion">

        <div class="accordion-item">
          <h2 class="accordion-header" id="personalityProfileHeading">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#personalityProfileCollapse" aria-expanded="true" aria-controls="personalityProfileCollapse">
              Personality Profile
            </button>
          </h2>
          <div id="personalityProfileCollapse" class="accordion-collapse collapse show" aria-labelledby="personalityProfileHeading" data-bs-parent="#profileAccordion">
            <div class="accordion-body">
              <% if @user.user_preference.present? %>
                <% 
                  # Determine survey completion status
                  basic_questions_count = SurveyQuestion.where("question_type LIKE 'big5_%' OR question_type LIKE 'ei_%'").where.not(question_type: 'attention_check').count
                  extended_questions_count = SurveyQuestion.where("question_type LIKE 'hexaco_%' OR question_type LIKE 'cognitive_%' OR question_type LIKE 'moral_%' OR question_type LIKE 'narrative_%' OR question_type LIKE 'psychological_%'").where.not(question_type: 'attention_check').count
                  
                  user_basic_responses_count = @user.survey_responses.joins(:survey_question).where("survey_questions.question_type LIKE 'big5_%' OR survey_questions.question_type LIKE 'ei_%'").where.not(survey_questions: { question_type: 'attention_check' }).count
                  user_extended_responses_count = @user.survey_responses.joins(:survey_question).where("survey_questions.question_type LIKE 'hexaco_%' OR survey_questions.question_type LIKE 'cognitive_%' OR survey_questions.question_type LIKE 'moral_%' OR survey_questions.question_type LIKE 'narrative_%' OR survey_questions.question_type LIKE 'psychological_%'").where.not(survey_questions: { question_type: 'attention_check' }).count
                  
                  basic_survey_completed = user_basic_responses_count >= basic_questions_count * 0.9 # 90% completion threshold
                  extended_survey_completed = user_extended_responses_count >= extended_questions_count * 0.9 # 90% completion threshold
                  extended_survey_started = user_extended_responses_count > 0

                  # Also check for HEXACO and Attachment Style questions
                  hexaco_questions_count = SurveyQuestion.where("question_type LIKE 'hexaco_%'").where.not(question_type: 'attention_check').count
                  user_hexaco_responses_count = @user.survey_responses.joins(:survey_question).where("survey_questions.question_type LIKE 'hexaco_%'").where.not(survey_questions: { question_type: 'attention_check' }).count
                  hexaco_completed = user_hexaco_responses_count >= hexaco_questions_count * 0.9

                  attachment_questions_count = SurveyQuestion.where("question_type LIKE 'attachment_%'").where.not(question_type: 'attention_check').count
                  user_attachment_responses_count = @user.survey_responses.joins(:survey_question).where("survey_questions.question_type LIKE 'attachment_%'").where.not(survey_questions: { question_type: 'attention_check' }).count
                  attachment_completed = user_attachment_responses_count >= attachment_questions_count * 0.9
                %>
                
                <% if basic_survey_completed %>
                  <% 
                    # Generate full profile using the service
                    full_profile = PersonalityProfileService.generate_profile(@user, true)
                  %>
                  
                  <!-- Debug Section (only visible to admins) -->
                  <% if @user.admin? %>
                    <div class="alert alert-secondary">
                      <h4>Debug Information (Admin Only)</h4>
                      <p>Basic Survey Completed: <%= basic_survey_completed %></p>
                      <p>Extended Survey Completed: <%= extended_survey_completed %></p>
                      <p>HEXACO Completed: <%= hexaco_completed %></p>
                      <p>Attachment Style Completed: <%= attachment_completed %></p>
                      <p>Profile Structure:</p>
                      <ul>
                        <li>Big Five: <%= full_profile[:big_five].keys.join(', ') %></li>
                        <li>Emotional Intelligence: <%= full_profile[:emotional_intelligence].keys.join(', ') %></li>
                        <li>Extended Traits Present: <%= full_profile[:extended_traits].present? %></li>
                        <% if full_profile[:extended_traits].present? %>
                          <li>HEXACO Present: <%= full_profile[:extended_traits][:hexaco].present? %></li>
                          <% if full_profile[:extended_traits][:hexaco].present? %>
                            <li>HEXACO Honesty-Humility Present: <%= full_profile[:extended_traits][:hexaco][:honesty_humility].present? %></li>
                  <% end %>
                          <li>Attachment Style Present: <%= full_profile[:extended_traits][:attachment_style].present? %></li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>

                  <!-- Tab Navigation and Content -->
                  <div class="row g-4">
                    <!-- Vertical Tabs -->
                    <div class="col-md-3">
                      <div class="nav flex-column nav-pills" id="personalityTabs" role="tablist" aria-orientation="vertical">
                        <button class="nav-link active mb-2" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
                          <i class="fas fa-home me-2"></i>Overview
                        </button>
                        <button class="nav-link mb-2" id="big5-tab" data-bs-toggle="pill" data-bs-target="#big5" type="button" role="tab" aria-controls="big5" aria-selected="false">
                          <i class="fas fa-chart-bar me-2"></i>Big Five
                        </button>
                        <button class="nav-link mb-2" id="ei-tab" data-bs-toggle="pill" data-bs-target="#ei" type="button" role="tab" aria-controls="ei" aria-selected="false">
                          <i class="fas fa-heart me-2"></i>Emotional Intelligence
                        </button>
                        <% if hexaco_completed || full_profile[:extended_traits]&.dig(:hexaco).present? %>
                          <button class="nav-link mb-2" id="hexaco-tab" data-bs-toggle="pill" data-bs-target="#hexaco" type="button" role="tab" aria-controls="hexaco" aria-selected="false">
                            <i class="fas fa-balance-scale me-2"></i>HEXACO
                          </button>
                        <% end %>
                        <% if attachment_completed || full_profile[:extended_traits]&.dig(:attachment_style).present? %>
                          <button class="nav-link mb-2" id="attachment-tab" data-bs-toggle="pill" data-bs-target="#attachment" type="button" role="tab" aria-controls="attachment" aria-selected="false">
                            <i class="fas fa-link me-2"></i>Attachment
                          </button>
                        <% end %>
                        <% if extended_survey_completed %>
                          <button class="nav-link mb-2" id="cognitive-tab" data-bs-toggle="pill" data-bs-target="#cognitive" type="button" role="tab" aria-controls="cognitive" aria-selected="false">
                            <i class="fas fa-brain me-2"></i>Cognitive
                          </button>
                          <button class="nav-link mb-2" id="moral-tab" data-bs-toggle="pill" data-bs-target="#moral" type="button" role="tab" aria-controls="moral" aria-selected="false">
                            <i class="fas fa-compass me-2"></i>Moral
                          </button>
                          <button class="nav-link mb-2" id="narrative-tab" data-bs-toggle="pill" data-bs-target="#narrative" type="button" role="tab" aria-controls="narrative" aria-selected="false">
                            <i class="fas fa-book-reader me-2"></i>Narrative
                          </button>
                          <button class="nav-link mb-2" id="psychological-tab" data-bs-toggle="pill" data-bs-target="#psychological" type="button" role="tab" aria-controls="psychological" aria-selected="false">
                            <i class="fas fa-puzzle-piece me-2"></i>Psychological
                          </button>
                          <button class="nav-link mb-2" id="dark-tab" data-bs-toggle="pill" data-bs-target="#dark" type="button" role="tab" aria-controls="dark" aria-selected="false">
                            <i class="fas fa-mask me-2"></i>Dark Content
                          </button>
                        <% end %>
                      </div>
                    </div>

                    <!-- Tab Content -->
                    <div class="col-md-9">
                      <div class="tab-content" id="personalityTabContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                          <div class="d-flex align-items-center gap-4 mb-4">
                            <img src="/assets/silhouettes.png" alt="Personality Assessment Illustration" class="img-fluid" style="width: 150px;">
                            <p class="mb-0 flex-grow-1" style="font-size: 0.9rem;">Cinematch combines the Big Five Personality Model, HEXACO Integrity Assessment, Attachment Style Analysis, and Emotional Intelligence measures to provide movie recommendations that match your unique traits and preferences.</p>
                          </div>

                          <% if @user.user_preference.personality_summary.blank? && basic_survey_completed %>
                            <% 
                              # Generate summary if it doesn't exist
                              @user.user_preference.personality_summary = PersonalitySummaryService.generate_summary(@user)
                            %>
                          <% end %>

                          <% if @user.user_preference.personality_summary.present? %>
                            <div class="alert alert-info bg-space-cadet rounded p-3 mb-4">
                              <div class="row g-0">
                                <div class="col-12">
                                  <h5 class="mb-2 text-jonquil">Your Personality Summary</h5>
                                  <p class="mb-0 text-mint-green"><%= @user.user_preference.personality_summary %></p>
                                </div>
                              </div>
                            </div>
                          <% end %>

                          <div class="mb-4">
                            <h5>Key Metrics</h5>
                            <div class="row g-3">
                              <!-- Big Five Highest Trait -->
                              <% if full_profile[:big_five].present? %>
                                <% 
                                  highest_trait = full_profile[:big_five].except(:personality_type).max_by{|k,v| v}
                                  trait_descriptions = {
                                    openness: "Openness reflects curiosity, creativity, and preference for variety. High scorers tend to be imaginative and adventurous.",
                                    conscientiousness: "Conscientiousness indicates organization, dependability, and self-discipline. High scorers are typically careful and diligent.",
                                    extraversion: "Extraversion relates to sociability, assertiveness, and emotional expressiveness. High scorers tend to be outgoing and energetic.",
                                    agreeableness: "Agreeableness represents traits like trust, altruism, and cooperation. High scorers are typically friendly and compassionate.",
                                    neuroticism: "Neuroticism reflects emotional stability and anxiety levels. High scorers may experience more stress and emotional reactivity."
                                  }
                                %>
                                <div class="col-md-6">
                                  <div class="p-3 border rounded h-100" data-bs-toggle="tooltip" data-bs-placement="top" title="<%= trait_descriptions[highest_trait[0].to_sym] %>">
                                    <div class="d-flex justify-content-between align-items-start">
                                      <h6 class="mb-3">
                                        Dominant Trait
                                      </h6>
                                      <span class="badge" style="background-color: var(--tufts-blue); color: var(--mint-green);"><%= highest_trait[1] %>%</span>
                                    </div>
                                    <p class="mb-0 text-capitalize"><%= highest_trait[0] %></p>
                                  </div>
                                </div>
                              <% end %>

                              <!-- Emotional Intelligence Level -->
                              <% if full_profile[:emotional_intelligence].present? && full_profile[:emotional_intelligence][:ei_level].present? %>
                                <div class="col-md-6">
                                  <div class="p-3 border rounded h-100" data-bs-toggle="tooltip" data-bs-placement="top" title="Your composite emotional intelligence score, measuring recognition, management, understanding, and adaptation of emotions. This influences how you connect with characters and emotional narratives.">
                                    <div class="d-flex justify-content-between align-items-start">
                                      <h6 class="mb-3">
                                        Emotional Intelligence
                                      </h6>
                                      <span class="badge" style="background-color: var(--jonquil); color: var(--space-cadet);"><%= full_profile[:emotional_intelligence][:composite_score] %>%</span>
                                    </div>
                                    <p class="mb-0"><%= full_profile[:emotional_intelligence][:ei_level].to_s.titleize %></p>
                                  </div>
                                </div>
                              <% end %>

                              <!-- HEXACO Integrity Level -->
                              <% if full_profile[:extended_traits].present? && full_profile[:extended_traits][:hexaco].present? %>
                                <div class="col-md-6">
                                  <div class="p-3 border rounded h-100" data-bs-toggle="tooltip" data-bs-placement="top" title="Your HEXACO Honesty-Humility score measures sincerity, fairness, and ethical principles. This influences your appreciation of moral themes and character motivations in stories.">
                                    <div class="d-flex justify-content-between align-items-start">
                                      <h6 class="mb-3">
                                        Integrity Level
                                      </h6>
                                      <span class="badge" style="background-color: var(--engineering-orange); color: var(--mint-green);">
                                        <%= full_profile[:extended_traits][:hexaco][:honesty_humility][:overall] %>%
                                      </span>
                                    </div>
                                    <p class="mb-0"><%= full_profile[:extended_traits][:hexaco][:integrity_level].to_s.titleize %></p>
                                  </div>
                                </div>
                              <% end %>

                              <!-- Attachment Style -->
                              <% if full_profile[:extended_traits].present? && full_profile[:extended_traits][:attachment_style].present? %>
                                <div class="col-md-6">
                                  <div class="p-3 border rounded h-100" data-bs-toggle="tooltip" data-bs-placement="top" title="Your attachment style reflects how you form emotional bonds and engage with relationships. This influences how you connect with character dynamics and relationship narratives in movies.">
                                    <div class="d-flex justify-content-between align-items-start">
                                      <h6 class="mb-3">
                                        Attachment Style
                                      </h6>
                                    </div>
                                    <p class="mb-0"><%= full_profile[:extended_traits][:attachment_style][:attachment_style].to_s.titleize.gsub('_', '-') %></p>
                                  </div>
                                </div>
                              <% end %>
                            </div>
                          </div>
                        </div>

                        <!-- Big Five Tab -->
                        <div class="tab-pane fade" id="big5" role="tabpanel" aria-labelledby="big5-tab">
                          <% if full_profile[:big_five].present? %>
                            <div class="mb-5">
                              <h3 class="mb-3">Big Five Personality Traits</h3>
                              <div class="alert alert-light border mb-4">
                                <p class="mb-0" style="font-size: 0.9rem;">The Big Five personality traits represent the most widely accepted model of personality in psychology. Your scores indicate your relative position on each dimension compared to the general population.</p>
                              </div>

                              <!-- Chart Section -->
                              <div class="text-center mb-4">
                                <div style="height: 300px; max-width: 600px; margin: 0 auto;">
                                  <canvas id="bigFiveChart"></canvas>
                                </div>
                                <p class="text-muted mt-2" style="font-size: 0.8rem;">The further a point is from the center, the stronger that trait is in your personality.</p>
                              </div>

                              <!-- Traits Section -->
                              <div class="row">
                          <% trait_descriptions = {
                               openness: "Openness reflects curiosity, creativity, and preference for variety. High scorers tend to be imaginative and adventurous.",
                               conscientiousness: "Conscientiousness indicates organization, dependability, and self-discipline. High scorers are typically careful and diligent.",
                               extraversion: "Extraversion relates to sociability, assertiveness, and emotional expressiveness. High scorers tend to be outgoing and energetic.",
                               agreeableness: "Agreeableness represents traits like trust, altruism, and cooperation. High scorers are typically friendly and compassionate.",
                                  neuroticism: "Neuroticism reflects emotional stability and anxiety levels. High scorers may experience more stress and emotional reactivity."
                                } %>
                                <% trait_implications = {
                                  openness: {
                                    high: "You likely enjoy films with complex narratives and artistic elements",
                                    medium: "You appreciate both familiar genres and novel experiences",
                                    low: "You may prefer straightforward storytelling and familiar genres"
                                  },
                                  conscientiousness: {
                                    high: "You might enjoy well-crafted plots with logical progression",
                                    medium: "You can appreciate both structured and free-flowing narratives",
                                    low: "You may enjoy spontaneous and unpredictable stories"
                                  },
                                  extraversion: {
                                    high: "You likely enjoy high-energy films with social themes",
                                    medium: "You appreciate both social and introspective stories",
                                    low: "You might prefer thoughtful, introspective films"
                                  },
                                  agreeableness: {
                                    high: "You may be drawn to stories about cooperation and connection",
                                    medium: "You can appreciate both harmonious and conflict-driven narratives",
                                    low: "You might enjoy stories with strategic thinking and complexity"
                                  },
                                  neuroticism: {
                                    high: "You may connect with emotionally complex narratives",
                                    medium: "You can engage with both intense and serene storytelling",
                                    low: "You might prefer stories with emotional balance"
                                  }
                                } %>
                                <% full_profile[:big_five].except(:personality_type).each_slice(3).each_with_index do |traits_group, index| %>
                                  <div class="col-md-6">
                                    <% traits_group.each do |trait, score| %>
                                      <div class="mb-3">
                                        <div class="trait-score">
                                          <div class="d-flex justify-content-between mb-1">
                                            <label>
                                              <span data-bs-toggle="tooltip" data-bs-placement="top" title="<%= trait_descriptions[trait.to_sym] %>">
                                                <strong><%= trait.to_s.titleize %></strong>
                              </span>
                                            </label>
                                            <span><%= score %>%</span>
                                          </div>
                                          <div class="progress mb-2">
                                            <div class="progress-bar bg-primary" 
                                                 role="progressbar" 
                                                 style="width: <%= score %>%"
                                                 aria-valuenow="<%= score %>" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                          </div>
                                          <% 
                                            level = if score >= 70
                                              "high"
                                            elsif score <= 30
                                              "low"
                                            else
                                              "medium"
                                            end
                                          %>
                                          <small class="text-muted"><%= trait_implications[trait.to_sym][level.to_sym] %></small>
                                        </div>
                                      </div>
                          <% end %>
                      </div>
                                <% end %>
                        </div>
                      </div>
                          <% end %>
                    </div>

                        <!-- Emotional Intelligence Tab -->
                        <div class="tab-pane fade" id="ei" role="tabpanel" aria-labelledby="ei-tab">
                          <% if full_profile[:emotional_intelligence].present? %>
                            <div class="mb-5">
                              <h3 class="mb-3">Emotional Intelligence</h3>
                              <div class="alert alert-light border mb-4">
                                <p class="mb-0" style="font-size: 0.9rem;">Emotional intelligence is the ability to understand and manage emotions effectively. Your profile shows your strengths across four key dimensions of emotional intelligence.</p>
                              </div>

                              <!-- Chart Section -->
                              <div class="text-center mb-4">
                                <div style="height: 300px; max-width: 600px; margin: 0 auto;">
                                  <canvas id="emotionalIntelligenceChart"></canvas>
                                </div>
                                <p class="text-muted mt-2" style="font-size: 0.8rem;">Larger segments represent stronger abilities in those emotional dimensions.</p>
                              </div>

                              <!-- Metrics Section -->
                              <div class="row">
                                <!-- EI Dimensions -->
                                <div class="col-md-6">
                                  <% ei_descriptions = {
                                    emotional_recognition: "The ability to identify and name emotions in yourself and others. High scorers are adept at recognizing emotional cues in facial expressions, body language, and tone of voice.",
                                    emotional_management: "The ability to regulate emotions effectively and respond appropriately to different situations. High scorers can manage strong emotions without being overwhelmed and can calm themselves when upset.",
                                    emotional_understanding: "The ability to understand complex emotions, how they evolve, and how they influence behavior. High scorers comprehend emotional causes and consequences and can predict emotional reactions.",
                                    emotional_adaptation: "The ability to adapt emotions to different situations and use them to facilitate thinking and behavior. High scorers can adjust their emotional responses appropriately to changing circumstances."
                                  } %>
                                  <% ei_implications = {
                                    emotional_recognition: {
                                      high: "You likely pick up on subtle emotional cues in films and connect deeply with character emotions.",
                                      medium: "You can generally recognize important emotional elements in stories and characters.",
                                      low: "You might focus more on plot and action than on emotional subtleties in films."
                                    },
                                    emotional_management: {
                                      high: "You can engage with emotionally intense content without becoming overwhelmed.",
                                      medium: "You can handle moderate emotional content but might need breaks during intense films.",
                                      low: "You might prefer films with less emotional intensity or clear emotional resolution."
                                    },
                                    emotional_understanding: {
                                      high: "You likely appreciate complex emotional narratives and character development.",
                                      medium: "You can follow emotional storylines but might miss some deeper emotional themes.",
                                      low: "You might prefer straightforward emotional arcs and clear character motivations."
                                    },
                                    emotional_adaptation: {
                                      high: "You can shift between different emotional tones in films and appreciate emotional complexity.",
                                      medium: "You can adapt to changing emotional tones but might prefer consistent emotional themes.",
                                      low: "You might prefer films with consistent emotional tones rather than emotional shifts."
                                    }
                                  } %>
                                  <% full_profile[:emotional_intelligence].except(:composite_score, :ei_level).each do |trait, score| %>
                                    <div class="mb-4">
                                      <div class="trait-score">
                                        <div class="d-flex justify-content-between mb-1">
                                          <label>
                                            <span data-bs-toggle="tooltip" data-bs-placement="top" title="<%= ei_descriptions[trait.to_sym] %>">
                                              <strong><%= trait.to_s.gsub('_', ' ').titleize %></strong >
                                            </span>
                                          </label>
                                          <span><%= score %>%</span>
                                        </div>
                                        <div class="progress mb-2">
                                          <div class="progress-bar bg-warning" 
                                               role="progressbar" 
                                               style="width: <%= score %>%"
                                               aria-valuenow="<%= score %>" 
                                               aria-valuemin="0" 
                                               aria-valuemax="100">
                                          </div>
                                        </div>
                                        <% 
                                          level = if score >= 70
                                            "high"
                                          elsif score <= 30
                                            "low"
                                          else
                                            "medium"
                                          end
                                        %>
                                        <small class="text-muted"><%= ei_implications[trait.to_sym][level.to_sym] %></small>
                                      </div>
                    </div>
                  <% end %>
                                </div>

                                <!-- Composite Score -->
                                <div class="col-md-6">
                                  <% if full_profile[:emotional_intelligence][:composite_score].present? && full_profile[:emotional_intelligence][:ei_level].present? %>
                                    <div class="alert alert-info p-3 rounded">
                                      <h5 class="mb-3">Overall Emotional Intelligence</h5>
                                      <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span>Composite Score</span>
                                        <span class="badge bg-warning text-dark"><%= full_profile[:emotional_intelligence][:composite_score] %>%</span>
                                      </div>
                                      <div class="mb-2">
                                        Level: <strong><%= full_profile[:emotional_intelligence][:ei_level].to_s.titleize %></strong>
                                      </div>
                                      <% 
                                        ei_level_descriptions = {
                                          "developing" => "You're building your emotional intelligence skills. You may benefit from content that helps you recognize and understand emotions more clearly.",
                                          "moderate" => "You have a balanced emotional intelligence profile. You can engage with emotionally complex content while still enjoying more straightforward narratives.",
                                          "strong" => "You have well-developed emotional intelligence. You likely appreciate nuanced emotional storytelling and complex character development.",
                                          "exceptional" => "You have highly developed emotional intelligence. You can deeply engage with emotionally complex narratives and subtle character dynamics."
                                        }
                                      %>
                                      <p class="mb-0"><%= ei_level_descriptions[full_profile[:emotional_intelligence][:ei_level]] %></p>
                                    </div>
                                  <% end %>
                                </div>
                              </div>
                            </div>
                          <% end %>
                        </div>

                        <!-- Extended Insights Tabs -->
                        <% if full_profile[:extended_traits].present? %>
                          <!-- HEXACO Tab -->
                          <% if full_profile[:extended_traits][:hexaco].present? %>
                            <div class="tab-pane fade" id="hexaco" role="tabpanel" aria-labelledby="hexaco-tab">
                              <div class="mb-5">
                                <h3 class="mb-3">HEXACO Assessment</h3>
                                <div class="alert alert-light border mb-4">
                                  <p class="mb-0" style="font-size: 0.9rem;">The HEXACO model extends personality assessment with a focus on Honesty-Humility, measuring traits like sincerity, fairness, and modesty. This helps understand how you engage with moral themes in stories.</p>
                                </div>

                                <!-- Chart Section -->
                                <div class="text-center mb-4">
                                  <div style="height: 300px; max-width: 600px; margin: 0 auto;">
                                    <canvas id="hexacoChart"></canvas>
                                  </div>
                                  <p class="text-muted mt-2" style="font-size: 0.8rem;">Higher scores indicate stronger presence of these personality aspects.</p>
                                </div>

                                <!-- Metrics Section -->
                                <div class="row">
                                  <!-- HEXACO Dimensions -->
                                  <div class="col-md-5">
                                    <% hexaco_descriptions = {
                                      honesty: "Tendency toward truthfulness and authenticity",
                                      sincerity: "Genuineness in interpersonal relations",
                                      fairness: "Commitment to ethical principles",
                                      modesty: "Being unassuming and humble",
                                      greedavoidance: "Moderation in material desires",
                                      faithfulness: "Loyalty in relationships"
                                    } %>
                                    <% full_profile[:extended_traits][:hexaco][:honesty_humility].except(:overall).each do |facet, score| %>
                                      <div class="mb-3">
                                        <div class="trait-score">
                                          <div class="d-flex justify-content-between mb-1">
                                            <label>
                                              <span data-bs-toggle="tooltip" data-bs-placement="top" title="<%= hexaco_descriptions[facet] %>">
                                                <strong><%= facet.to_s.titleize %></strong>
                                              </span>
                                            </label>
                                            <span><%= score %>%</span>
                                          </div>
                                          <div class="progress mb-2">
                                            <div class="progress-bar bg-info" 
                                                 role="progressbar" 
                                                 style="width: <%= score %>%"
                                                 aria-valuenow="<%= score %>" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    <% end %>
                                  </div>

                                  <!-- Composite Score -->
                                  <div class="col-md-7">
                                    <div class="alert alert-info p-3 rounded">
                                      <h5 class="mb-3">Overall Integrity Profile</h5>
                                      <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span>Honesty-Humility Score</span>
                                        <span class="badge bg-info"><%= full_profile[:extended_traits][:hexaco][:honesty_humility][:overall] %>%</span>
                                      </div>
                                      <div class="mb-2">
                                        Level: <strong><%= full_profile[:extended_traits][:hexaco][:integrity_level].to_s.titleize %></strong>
                                      </div>
                                      <% 
                                        integrity_descriptions = {
                                          "opportunistic" => "You take a practical approach to ethics, adapting to circumstances. You may enjoy morally complex characters and strategic narratives.",
                                          "pragmatic" => "You balance principles with practicality. You appreciate stories that explore ethical dilemmas and moral trade-offs.",
                                          "principled" => "You value ethical behavior highly. You connect with characters who maintain their integrity despite challenges.",
                                          "highly_principled" => "You have strong ethical convictions. You resonate with stories about moral courage and justice."
                                        }
                                      %>
                                      <p class="mb-0"><%= integrity_descriptions[full_profile[:extended_traits][:hexaco][:integrity_level]] %></p>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          <% end %>

                          <!-- Attachment Style Tab -->
                          <% if full_profile[:extended_traits][:attachment_style].present? %>
                            <div class="tab-pane fade" id="attachment" role="tabpanel" aria-labelledby="attachment-tab">
                              <div class="mb-5">
                                <h3 class="mb-3">Attachment Style</h3>
                                <div class="alert alert-light border mb-4">
                                  <p class="mb-0" style="font-size: 0.9rem;">Your attachment style reflects how you form emotional bonds and engage with relationships. This influences your connection with character dynamics and relationship narratives in movies.</p>
                                </div>

                                <!-- Chart Section -->
                                <div class="text-center mb-4">
                                  <div style="height: 300px; max-width: 600px; margin: 0 auto;">
                                    <canvas id="attachmentStyleChart"></canvas>
                                  </div>
                                  <p class="text-muted mt-2" style="font-size: 0.8rem;">Your position on the chart indicates your attachment style based on anxiety and avoidance levels.</p>
                                </div>

                                <!-- Metrics Section -->
                                <div class="row">
                                  <!-- Attachment Dimensions -->
                                  <div class="col-md-5">
                                    <div class="mb-3">
                                      <div class="trait-score">
                                        <div class="d-flex justify-content-between mb-1">
                                          <label>
                                            <span data-bs-toggle="tooltip" data-bs-placement="top" title="Level of worry about rejection or abandonment in relationships">
                                              <strong>Attachment Anxiety</strong>
                                            </span>
                                          </label>
                                          <span><%= full_profile[:extended_traits][:attachment_style][:anxiety] %>%</span>
                                        </div>
                                        <div class="progress mb-2">
                                          <div class="progress-bar bg-danger" 
                                               role="progressbar" 
                                               style="width: <%= full_profile[:extended_traits][:attachment_style][:anxiety] %>%"
                                               aria-valuenow="<%= full_profile[:extended_traits][:attachment_style][:anxiety] %>" 
                                               aria-valuemin="0" 
                                               aria-valuemax="100">
                                          </div>
                                        </div>
                                      </div>
                                    </div>

                                    <div class="mb-3">
                                      <div class="trait-score">
                                        <div class="d-flex justify-content-between mb-1">
                                          <label>
                                            <span data-bs-toggle="tooltip" data-bs-placement="top" title="Level of comfort with emotional closeness and dependency in relationships">
                                              <strong>Attachment Avoidance</strong>
                                            </span>
                                          </label>
                                          <span><%= full_profile[:extended_traits][:attachment_style][:avoidance] %>%</span>
                                        </div>
                                        <div class="progress mb-2">
                                          <div class="progress-bar bg-secondary" 
                                               role="progressbar" 
                                               style="width: <%= full_profile[:extended_traits][:attachment_style][:avoidance] %>%"
                                               aria-valuenow="<%= full_profile[:extended_traits][:attachment_style][:avoidance] %>" 
                                               aria-valuemin="0" 
                                               aria-valuemax="100">
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  <!-- Style Description -->
                                  <div class="col-md-7">
                                    <div class="alert alert-info p-3 rounded">
                                      <h5 class="mb-3">Your Attachment Style</h5>
                                      <div class="mb-2">
                                        Style: <strong><%= full_profile[:extended_traits][:attachment_style][:attachment_style].to_s.titleize.gsub('_', '-') %></strong>
                                      </div>
                                      <% 
                                        attachment_descriptions = {
                                          "secure" => "You're comfortable with both independence and emotional connection. You can enjoy various relationship narratives without becoming overwhelmed.",
                                          "anxious" => "You value emotional closeness highly. You likely connect deeply with relationship-focused stories and character development.",
                                          "avoidant" => "You prefer emotional independence. You might favor action or plot-driven content over relationship-focused narratives.",
                                          "fearful_avoidant" => "You have complex feelings about relationships. You may appreciate stories that explore both connection and independence."
                                        }
                                      %>
                                      <p class="mb-0"><%= attachment_descriptions[full_profile[:extended_traits][:attachment_style][:attachment_style]] %></p>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          <% end %>

                          <!-- Cognitive Profile Tab -->
                          <% if full_profile[:extended_traits][:cognitive].present? %>
                            <div class="tab-pane fade" id="cognitive" role="tabpanel" aria-labelledby="cognitive-tab">
                              <div class="mb-5">
                                <h3 class="mb-3">Cognitive Profile</h3>
                                <div class="alert alert-light border mb-4">
                                  <p class="mb-0" style="font-size: 0.9rem;">Your cognitive profile shows how you process and engage with information, affecting your preferences for different types of narratives and storytelling styles.</p>
                                </div>

                                <!-- Chart Section -->
                                <div class="text-center mb-4">
                                  <div style="height: 300px; max-width: 600px; margin: 0 auto;">
                                    <canvas id="cognitiveChart"></canvas>
                                  </div>
                                  <p class="text-muted mt-2" style="font-size: 0.8rem;">Your position on each dimension shows your cognitive preferences.</p>
                                </div>

                                <!-- Cognitive Dimensions -->
                                <div class="row">
                                  <div class="col-12">
                                    <% cognitive_dimensions = {
                                      visual_verbal: {
                                        pair: ["Visual Processing", "Verbal Processing"],
                                        description: "How you prefer to process information - through visual imagery or through words and language"
                                      },
                                      systematic_intuitive: {
                                        pair: ["Systematic Thinking", "Intuitive Thinking"],
                                        description: "Your approach to problem-solving - through methodical analysis or through gut feelings and instinct"
                                      },
                                      abstract_concrete: {
                                        pair: ["Abstract Concepts", "Concrete Details"],
                                        description: "Your preference for dealing with theoretical ideas versus tangible, specific information"
                                      },
                                      certainty_ambiguity: {
                                        pair: ["Need for Certainty", "Comfort with Ambiguity"],
                                        description: "How comfortable you are with unclear or open-ended situations versus needing clear answers"
                                      },
                                      detail_pattern: {
                                        pair: ["Detail Focus", "Pattern Recognition"],
                                        description: "Whether you tend to focus on specific details or look for broader patterns and connections"
                                      }
                                    } %>

                                    <% full_profile[:extended_traits][:cognitive].except(:primary_style).each do |dimension, data| %>
                                      <div class="mb-4">
                                        <h6 class="mb-2" data-bs-toggle="tooltip" data-bs-placement="top" title="<%= cognitive_dimensions[dimension][:description] %>">
                                          <%= dimension.to_s.titleize.gsub('_', ' vs ') %>
                                        </h6>
                                        <div class="position-relative">
                                          <div class="progress">
                                            <% 
                                              normalized_score = ((data[:score] + 100) / 2).round
                                              left_color = "bg-info"
                                              right_color = "bg-primary"
                                            %>
                                            <div class="progress-bar <%= left_color %>" role="progressbar" 
                                                 style="width: <%= normalized_score %>%"
                                                 aria-valuenow="<%= normalized_score %>" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                          </div>
                                          <div class="d-flex justify-content-between mt-1">
                                            <small class="text-muted"><%= cognitive_dimensions[dimension][:pair][0] %></small>
                                            <small class="text-muted"><%= cognitive_dimensions[dimension][:pair][1] %></small>
                                          </div>
                                        </div>
                                      </div>
                                    <% end %>

                                    <div class="alert alert-info mt-4">
                                      <h5 class="mb-3">Primary Cognitive Style: <%= full_profile[:extended_traits][:cognitive][:primary_style].to_s.titleize %></h5>
                                      <p class="mb-0">
                                        <%= case full_profile[:extended_traits][:cognitive][:primary_style].to_s
                                          when 'balanced'
                                            "You have a flexible cognitive style, adapting your approach based on the situation."
                                          when 'visual_verbal'
                                            data = full_profile[:extended_traits][:cognitive][:visual_verbal]
                                            if data[:score] < 0
                                              "You tend to process information visually, preferring movies with strong visual storytelling."
                                            else
                                              "You appreciate well-crafted dialogue and narrative exposition in films."
                                            end
                                          when 'systematic_intuitive'
                                            data = full_profile[:extended_traits][:cognitive][:systematic_intuitive]
                                            if data[:score] < 0
                                              "You enjoy movies with logical, well-structured plots and clear progression."
                                            else
                                              "You connect well with emotionally-driven narratives and abstract storytelling."
                                            end
                                          when 'abstract_concrete'
                                            data = full_profile[:extended_traits][:cognitive][:abstract_concrete]
                                            if data[:score] < 0
                                              "You appreciate films that explore abstract concepts and metaphorical meanings."
                                            else
                                              "You prefer stories grounded in concrete reality and tangible situations."
                                            end
                                          when 'certainty_ambiguity'
                                            data = full_profile[:extended_traits][:cognitive][:certainty_ambiguity]
                                            if data[:score] < 0
                                              "You prefer films with clear resolutions and definitive endings."
                                            else
                                              "You enjoy movies that leave room for interpretation and ambiguity."
                                            end
                                          when 'detail_pattern'
                                            data = full_profile[:extended_traits][:cognitive][:detail_pattern]
                                            if data[:score] < 0
                                              "You appreciate attention to detail and nuanced storytelling in films."
                                            else
                                              "You enjoy recognizing patterns and connecting threads across narratives."
                                            end
                                          end %>
                                      </p>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          <% end %>

                          <!-- Moral Foundations Tab -->
                          <% if full_profile[:extended_traits]&.dig(:moral_foundations).present? %>
                            <div class="tab-pane fade" id="moral" role="tabpanel" aria-labelledby="moral-tab">
                              <div class="mb-5">
                                <h3 class="mb-3">Moral Foundations</h3>
                                <div class="alert alert-light border mb-4">
                                  <p class="mb-0" style="font-size: 0.9rem;">Your moral foundations profile shows how you engage with different ethical themes and values in storytelling.</p>
                                </div>

                                <!-- Chart Section -->
                                <div class="text-center mb-4">
                                  <div style="height: 300px; max-width: 600px; margin: 0 auto;">
                                    <canvas id="moralFoundationsChart"></canvas>
                                  </div>
                                  <p class="text-muted mt-2" style="font-size: 0.8rem;">Higher scores indicate stronger resonance with these moral values.</p>
                                </div>

                                <!-- Moral Dimensions -->
                                <div class="row">
                                  <div class="col-md-6">
                                    <% moral_dimensions = {
                                      care: {
                                        description: "Sensitivity to others' suffering and the desire to prevent harm",
                                        implications: {
                                          high: "You strongly connect with stories about protecting the vulnerable and preventing harm",
                                          medium: "You appreciate themes of care and protection in balance with other values",
                                          low: "You may focus more on other moral themes than on care-based narratives"
                                        }
                                      },
                                      fairness: {
                                        description: "Concern for justice, rights, and equality",
                                        implications: {
                                          high: "You are drawn to stories about justice, equality, and fair treatment",
                                          medium: "You value fairness while recognizing practical limitations",
                                          low: "You may focus more on other aspects than strict fairness in stories"
                                        }
                                      },
                                      loyalty: {
                                        description: "Value placed on group belonging and faithfulness",
                                        implications: {
                                          high: "You appreciate stories about loyalty, patriotism, and group bonds",
                                          medium: "You balance group loyalty with individual principles",
                                          low: "You may prefer stories focusing on individual over group dynamics"
                                        }
                                      },
                                      authority: {
                                        description: "Respect for tradition and legitimate authority",
                                        implications: {
                                          high: "You connect with stories about duty, respect, and traditional values",
                                          medium: "You appreciate both traditional and questioning perspectives",
                                          low: "You may prefer stories that challenge established authority"
                                        }
                                      },
                                      purity: {
                                        description: "Concern for sanctity and spiritual/physical cleanliness",
                                        implications: {
                                          high: "You resonate with themes of spiritual growth and moral elevation",
                                          medium: "You appreciate both sacred and secular themes in stories",
                                          low: "You may prefer pragmatic over spiritual/moral purity themes"
                                        }
                                      }
                                    } %>

                                    <% if full_profile[:extended_traits][:moral_foundations].present? %>
                                      <% full_profile[:extended_traits][:moral_foundations].slice(:care, :fairness, :loyalty, :authority, :purity).each do |foundation, score| %>
                                        <div class="mb-3">
                                          <div class="trait-score">
                                            <div class="d-flex justify-content-between mb-1">
                                              <label>
                                                <span data-bs-toggle="tooltip" data-bs-placement="top" title="<%= moral_dimensions[foundation][:description] %>">
                                                  <strong><%= foundation.to_s.titleize %></strong>
                                                </span>
                                              </label>
                                              <span><%= score %>%</span>
                                            </div>
                                            <div class="progress mb-2">
                                              <div class="progress-bar bg-warning" 
                                                   role="progressbar" 
                                                   style="width: <%= score %>%"
                                                   aria-valuenow="<%= score %>" 
                                                   aria-valuemin="0" 
                                                   aria-valuemax="100">
                                              </div>
                                            </div>
                                            <% 
                                              level = if score >= 70
                                                "high"
                                              elsif score <= 30
                                                "low"
                                              else
                                                "medium"
                                              end
                                            %>
                                            <small class="text-muted"><%= moral_dimensions[foundation][:implications][level.to_sym] %></small>
                                          </div>
                                        </div>
                                      <% end %>
                                    <% end %>
                                  </div>

                                  <!-- Content Preferences -->
                                  <div class="col-md-6">
                                    <div class="alert alert-info">
                                      <h5 class="mb-3">Content Preferences</h5>
                                      <p class="mb-0"><%= full_profile[:extended_traits][:moral_foundations][:content_preferences] rescue "No content preferences available" %></p>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          <% end %>

                          <!-- Narrative Profile Tab -->
                          <% if full_profile[:extended_traits][:narrative].present? %>
                            <div class="tab-pane fade" id="narrative" role="tabpanel" aria-labelledby="narrative-tab">
                              <div class="mb-5">
                                <h3 class="mb-3">Narrative Profile</h3>
                                <div class="alert alert-light border mb-4">
                                  <p class="mb-0" style="font-size: 0.9rem;">Your narrative profile reveals how you engage with stories and what types of storytelling resonate with you most.</p>
                                </div>

                                <!-- Chart Section -->
                                <div class="text-center mb-4">
                                  <div style="height: 300px; max-width: 600px; margin: 0 auto;">
                                    <canvas id="narrativeChart"></canvas>
                                  </div>
                                  <p class="text-muted mt-2" style="font-size: 0.8rem;">Higher scores indicate stronger engagement with these narrative aspects.</p>
                                </div>

                                <!-- Narrative Dimensions -->
                                <div class="row">
                                  <div class="col-md-6">
                                    <% narrative_dimensions = {
                                      immersion: {
                                        description: "Your ability to become deeply absorbed in a story, losing track of time and surroundings",
                                        implications: {
                                          high: "You easily become fully immersed in stories, making them feel vivid and real",
                                          medium: "You can become immersed while maintaining awareness of your surroundings",
                                          low: "You tend to maintain emotional distance from stories"
                                        }
                                      },
                                      character_identification: {
                                        description: "How strongly you identify with and relate to characters in stories",
                                        implications: {
                                          high: "You form strong emotional connections with characters and their journeys",
                                          medium: "You can relate to characters while maintaining perspective",
                                          low: "You focus more on plot and themes than character relationships"
                                        }
                                      },
                                      complexity_preference: {
                                        description: "Your comfort with and enjoyment of complex, multilayered narratives",
                                        implications: {
                                          high: "You enjoy intricate plots with multiple storylines and deep themes",
                                          medium: "You appreciate both simple and complex narratives",
                                          low: "You prefer straightforward, focused storytelling"
                                        }
                                      },
                                      mental_imagery: {
                                        description: "Your ability to create vivid mental images from narrative descriptions",
                                        implications: {
                                          high: "You easily visualize scenes and create rich mental imagery",
                                          medium: "You can form mental images while following the story",
                                          low: "You focus more on dialogue and action than visual details"
                                        }
                                      }
                                    } %>

                                    <% full_profile[:extended_traits][:narrative].slice(:immersion, :character_identification, :complexity_preference, :mental_imagery).each do |dimension, score| %>
                                      <div class="mb-3">
                                        <div class="trait-score">
                                          <div class="d-flex justify-content-between mb-1">
                                            <label>
                                              <span data-bs-toggle="tooltip" data-bs-placement="top" title="<%= narrative_dimensions[dimension][:description] %>">
                                                <strong><%= dimension.to_s.titleize.gsub('_', ' ') %></strong>
                                              </span>
                                            </label>
                                            <span><%= score %>%</span>
                                          </div>
                                          <div class="progress mb-2">
                                            <div class="progress-bar bg-info" 
                                                 role="progressbar" 
                                                 style="width: <%= score %>%"
                                                 aria-valuenow="<%= score %>" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                          </div>
                                          <% 
                                            level = if score >= 70
                                              "high"
                                            elsif score <= 30
                                              "low"
                                            else
                                              "medium"
                                            end
                                          %>
                                          <small class="text-muted"><%= narrative_dimensions[dimension][:implications][level.to_sym] %></small>
                                        </div>
                                      </div>
                                    <% end %>
                                  </div>

                                  <!-- Style Preference -->
                                  <div class="col-md-6">
                                    <div class="alert alert-info">
                                      <h5 class="mb-3">Narrative Style: <%= full_profile[:extended_traits][:narrative][:narrative_style_preference].to_s.titleize.gsub('_', ' ') %></h5>
                                      <p class="mb-0"><%= full_profile[:extended_traits][:narrative][:film_recommendations] %></p>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          <% end %>

                          <!-- Psychological Needs Tab -->
                          <% if full_profile[:extended_traits]&.dig(:psychological_needs).present? %>
                            <div class="tab-pane fade" id="psychological" role="tabpanel" aria-labelledby="psychological-tab">
                              <div class="mb-5">
                                <h3 class="mb-3">Psychological Needs</h3>
                                <div class="alert alert-light border mb-4">
                                  <p class="mb-0" style="font-size: 0.9rem;">Your psychological needs profile shows what motivates you and what you seek in media experiences.</p>
                                </div>

                                <!-- Chart Section -->
                                <div class="text-center mb-4">
                                  <div style="height: 300px; max-width: 600px; margin: 0 auto;">
                                    <canvas id="psychologicalChart"></canvas>
                                  </div>
                                  <p class="text-muted mt-2" style="font-size: 0.8rem;">Higher scores indicate stronger psychological needs in these areas.</p>
                                </div>

                                <!-- Psychological Dimensions -->
                                <div class="row">
                                  <div class="col-md-6">
                                    <% psych_dimensions = {
                                      autonomy: {
                                        description: "Your need for independence and self-directed choice in experiences",
                                        implications: {
                                          high: "You strongly connect with stories about personal freedom and self-determination",
                                          medium: "You appreciate both independent and guided narratives",
                                          low: "You may focus less on themes of personal autonomy"
                                        }
                                      },
                                      competence: {
                                        description: "Your desire to feel effective and capable in your actions",
                                        implications: {
                                          high: "You enjoy stories about mastery, achievement, and overcoming challenges",
                                          medium: "You appreciate both growth and established competence",
                                          low: "You may focus less on achievement-oriented narratives"
                                        }
                                      },
                                      relatedness: {
                                        description: "Your need for meaningful connections and belonging",
                                        implications: {
                                          high: "You strongly resonate with stories about relationships and community",
                                          medium: "You value both connection and independence in stories",
                                          low: "You may prefer stories focusing on individual journeys"
                                        }
                                      },
                                      escapism: {
                                        description: "Your desire to temporarily disengage from daily concerns",
                                        implications: {
                                          high: "You seek immersive experiences that provide relief from reality",
                                          medium: "You balance escapist entertainment with grounded content",
                                          low: "You prefer content that connects to real-world experiences"
                                        }
                                      },
                                      inspiration: {
                                        description: "Your need for uplifting and motivating experiences",
                                        implications: {
                                          high: "You strongly connect with inspiring and transformative stories",
                                          medium: "You appreciate both inspiring and realistic narratives",
                                          low: "You may prefer more grounded or pragmatic content"
                                        }
                                      }
                                    } %>

                                    <% if full_profile[:extended_traits][:psychological_needs].present? %>
                                      <% full_profile[:extended_traits][:psychological_needs].slice(:autonomy, :competence, :relatedness, :escapism, :inspiration).each do |need, score| %>
                                        <div class="mb-3">
                                          <div class="trait-score">
                                            <div class="d-flex justify-content-between mb-1">
                                              <label>
                                                <span data-bs-toggle="tooltip" data-bs-placement="top" title="<%= psych_dimensions[need][:description] %>">
                                                  <strong><%= need.to_s.titleize %></strong>
                                                </span>
                                              </label>
                                              <span><%= score %>%</span>
                                            </div>
                                            <div class="progress mb-2">
                                              <div class="progress-bar bg-primary" 
                                                   role="progressbar" 
                                                   style="width: <%= score %>%"
                                                   aria-valuenow="<%= score %>" 
                                                   aria-valuemin="0" 
                                                   aria-valuemax="100">
                                              </div>
                                            </div>
                                            <% 
                                              level = if score >= 70
                                                "high"
                                              elsif score <= 30
                                                "low"
                                              else
                                                "medium"
                                              end
                                            %>
                                            <small class="text-muted"><%= psych_dimensions[need][:implications][level.to_sym] %></small>
                                          </div>
                                        </div>
                                      <% end %>
                                    <% end %>
                                  </div>

                                  <!-- Content Alignment -->
                                  <div class="col-md-6">
                                    <div class="alert alert-info">
                                      <h5 class="mb-3">Media Function: <%= full_profile[:extended_traits][:psychological_needs][:media_function].to_s.titleize.gsub('_', ' ') rescue "Unknown" %></h5>
                                      <p class="mb-0"><%= full_profile[:extended_traits][:psychological_needs][:content_alignment] rescue "No content alignment available" %></p>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          <% end %>

                          <!-- Dark Content Tab -->
                          <div class="tab-pane fade" id="dark" role="tabpanel" aria-labelledby="dark-tab">
                            <div class="mb-5">
                              <h3 class="mb-3">Dark Triad</h3>
                              <div class="alert alert-light border mb-4">
                                <p class="mb-0" style="font-size: 0.9rem;">Your Dark Triad profile indicates how you engage with complex character motivations and psychological themes in media.</p>
                              </div>

                              <% if full_profile[:extended_traits]&.dig(:dark_triad).present? %>
                                <!-- Chart Section -->
                                <div class="text-center mb-4">
                                  <div style="height: 300px; max-width: 600px; margin: 0 auto;">
                                    <canvas id="darkChart"></canvas>
                                  </div>
                                  <p class="text-muted mt-2" style="font-size: 0.8rem;">Higher scores indicate greater resonance with these psychological themes.</p>
                                </div>

                                <!-- Dark Content Dimensions -->
                                <div class="row">
                                  <div class="col-md-6">
                                    <% dark_dimensions = {
                                      machiavellianism_appeal: {
                                        description: "Comfort with themes of manipulation and strategic deception",
                                        implications: {
                                          high: "Strong interest in complex power dynamics and strategic manipulation in stories",
                                          medium: "Moderate engagement with themes of social maneuvering",
                                          low: "Preference for straightforward narratives with clear moral positions"
                                        }
                                      },
                                      narcissism_appeal: {
                                        description: "Interest in themes of grandiosity and self-importance",
                                        implications: {
                                          high: "Drawn to stories about exceptional individuals and dramatic personal achievement",
                                          medium: "Balanced interest in both personal achievement and collective stories",
                                          low: "Preference for humble characters and community-focused narratives"
                                        }
                                      },
                                      psychopathy_appeal: {
                                        description: "Tolerance for intense or disturbing content",
                                        implications: {
                                          high: "Can handle intense psychological thrillers and dark themes",
                                          medium: "Moderate tolerance for challenging content",
                                          low: "Preference for lighter content with less psychological intensity"
                                        }
                                      }
                                    } %>

                                    <% dark_dimensions.each do |dimension, info| %>
                                      <% score = full_profile[:extended_traits][:dark_triad][dimension] %>
                                      <div class="mb-3">
                                        <div class="trait-score">
                                          <div class="d-flex justify-content-between mb-1">
                                            <label>
                                              <span data-bs-toggle="tooltip" data-bs-placement="top" title="<%= info[:description] %>">
                                                <strong><%= dimension.to_s.gsub('_appeal', '').titleize %></strong>
                                              </span>
                                            </label>
                                            <span><%= score %>%</span>
                                          </div>
                                          <div class="progress mb-2">
                                            <div class="progress-bar bg-danger" 
                                                 role="progressbar" 
                                                 style="width: <%= score %>%"
                                                 aria-valuenow="<%= score %>" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                          </div>
                                          <% 
                                            level = if score >= 70
                                              "high"
                                            elsif score <= 30
                                              "low"
                                            else
                                              "medium"
                                            end
                                          %>
                                          <small class="text-muted"><%= info[:implications][level.to_sym] %></small>
                                        </div>
                                      </div>
                                    <% end %>
                                  </div>

                                  <!-- Content Recommendations -->
                                  <div class="col-md-6">
                                    <div class="alert alert-info">
                                      <h5 class="mb-3">Content Recommendations</h5>
                                      <p class="mb-0"><%= full_profile[:extended_traits][:dark_triad][:content_recommendations] rescue "No content recommendations available" %></p>
                                    </div>
                                  </div>
                                </div>
                              <% else %>
                                <div class="alert alert-info">
                                  <p class="mb-0">Dark content preferences data is not available. Please complete the extended survey to see this information.</p>
                                </div>
                              <% end %>
                            </div>
                          </div>
                        <% end %>
                      </div>
                      
                      <!-- Survey Action Buttons (simplified) -->
                      <div class="mt-4 d-flex gap-2">
                        <% if basic_survey_completed && extended_survey_completed %>
                          <%= link_to "Retake Basic Survey", surveys_path(type: 'basic'), class: "btn btn-outline-primary" %>
                          <%= link_to "Retake Extended Survey", surveys_path(type: 'extended'), class: "btn btn-outline-primary" %>
                        <% elsif basic_survey_completed && extended_survey_started %>
                          <%= link_to "Retake Basic Survey", surveys_path(type: 'basic'), class: "btn btn-outline-primary" %>
                          <%= link_to "Continue Extended Survey", surveys_path(type: 'extended'), class: "btn btn-primary" %>
                        <% elsif basic_survey_completed %>
                          <%= link_to "Retake Basic Survey", surveys_path(type: 'basic'), class: "btn btn-outline-primary" %>
                          <%= link_to "Take Extended Survey", surveys_path(type: 'extended'), class: "btn btn-primary" %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% else %>
                  <div class="alert alert-info" role="alert">
                    <h4 class="alert-heading">Welcome to Your Personality Profile!</h4>
                    <p>To get personalized movie recommendations, we need to understand your preferences better. Please complete our personality survey to unlock your profile.</p>
                    <hr>
                    <p class="mb-0">
                      <%= link_to "Take Basic Survey", surveys_path(type: 'basic'), class: "btn btn-primary" %>
                    </p>
                  </div>
                <% end %>
              <% else %>
                <div class="alert alert-warning" role="alert">
                  No preferences found. Please complete the <%= link_to "survey", surveys_path, class: "alert-link" %> to receive recommendations.
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header" id="contentPreferencesHeading">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#contentPreferencesCollapse" aria-expanded="false" aria-controls="contentPreferencesCollapse">
              Content Preferences
            </button>
          </h2>
          <div id="contentPreferencesCollapse" class="accordion-collapse collapse" aria-labelledby="contentPreferencesHeading" data-bs-parent="#profileAccordion">
            <div class="accordion-body">
              <h3>Edit Content Preferences</h3>
              <%= form_with model: @user_preference, local: true do |form| %>
                <div class="mb-3">
                  <%= form.label :favorite_genres, "Select your favorite genres", class: "form-label" %><br>
                  <div class="btn-group-toggle d-flex flex-wrap" data-toggle="buttons">
                    <% @genres.each do |genre| %>
                      <%= form.check_box :favorite_genres, { multiple: true, class: "btn-check", id: genre["name"].parameterize }, genre["name"], nil %>
                      <%= label_tag genre["name"].parameterize, genre["name"], class: "btn btn-outline-primary m-1" %>
                    <% end %>
                  </div>
                </div>
                <div class="form-group mb-3">
                  <label for="disable_adult_content" class="form-label">Adult Content</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="disable_adult_content" name="user_preference[disable_adult_content]" value="1" <%= @user_preference.disable_adult_content ? 'checked' : '' %> />
                    <label class="form-check-label" for="disable_adult_content">
                      <span>Exclude adult content from recommendations</span>
                    </label>
                  </div>
                </div>
                <div class="form-group mb-1">
                  <label for="use_ai" class="form-label">Recommendation System</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="use_ai" name="user_preference[use_ai]" value="1" <%= @user_preference.use_ai ? 'checked' : '' %> data-action="change->preferences#toggleAiOptions" />
                    <label class="form-check-label" for="use_ai">
                      <span>Use AI-powered recommendations</span>
                    </label>
                    <small class="form-text text-muted d-block">
                      Switch between traditional matching and AI-powered content recommendations
                    </small>
                  </div>
                </div>
                <div id="ai-options" class="mb-3 ms-5" data-preferences-target="aiOptions" style="display: <%= @user_preference.use_ai ? 'block' : 'none' %>">
                  <div class="form-group">
                    <label for="ai_model" class="form-label">AI Model</label>
                    <%= select_tag "user_preference[ai_model]",
                        options_for_select(
                          @available_models.map { |key, config| 
                            ["#{config[:name]} - #{config[:description]}", key]
                          },
                          @user_preference.ai_model
                        ),
                        class: "form-select"
                    %>
                  </div>
                </div>
                <div>
                  <%= form.submit "Save Preferences", class: "btn btn-primary" %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="settingsHeading">
            <button class="accordion-button collapsed rounded-0" type="button" data-bs-toggle="collapse" data-bs-target="#settingsCollapse" aria-expanded="false" aria-controls="settingsCollapse">
              User Settings
            </button>
          </h2>
          <div id="settingsCollapse" class="accordion-collapse collapse" aria-labelledby="settingsHeading" data-bs-parent="#profileAccordion">
            <div class="accordion-body">
              <h3 class="mt-4">Edit Personal Information</h3>
              <%= render "users/edit" %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tooltips with specific configuration
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl, {
      html: true,
      delay: { show: 50, hide: 50 },
      animation: true,
      placement: 'top'
    });
  });

  // Chart initialization functions
  function initializeRadarChart(canvasId, data, label, colorSet) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
  new Chart(ctx, {
    type: 'radar',
    data: {
        labels: Object.keys(data).map(key => key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')),
      datasets: [{
          label: label,
        data: Object.values(data),
          backgroundColor: colorSet.bgColor,
          borderColor: colorSet.borderColor,
          pointBackgroundColor: colorSet.borderColor,
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: colorSet.borderColor
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
            angleLines: { display: true },
            suggestedMin: 0,
            suggestedMax: 100
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  }

  function initializePolarAreaChart(canvasId, data, colors) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'polarArea',
      data: {
        labels: Object.keys(data).map(key => key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')),
        datasets: [{
          data: Object.values(data),
          backgroundColor: colors.bgColors,
          borderColor: colors.borderColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            beginAtZero: true,
            suggestedMax: 100
          }
        },
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  // Initialize Big Five Chart
  const bigFiveData = <%= raw (full_profile&.dig(:big_five)&.except(:personality_type) || {}).to_json %>;
  initializeRadarChart('bigFiveChart', bigFiveData, 'Big Five Personality Traits', {
    bgColor: 'rgba(26, 143, 227, 0.2)',
    borderColor: 'rgb(26, 143, 227)'
  });

  // Initialize Emotional Intelligence Chart
  const eiData = <%= raw (full_profile&.dig(:emotional_intelligence)&.except(:composite_score, :ei_level) || {}).to_json %>;
  initializePolarAreaChart('emotionalIntelligenceChart', eiData, {
    bgColors: [
      'rgba(255, 206, 86, 0.5)',
      'rgba(255, 159, 64, 0.5)',
      'rgba(255, 99, 132, 0.5)',
      'rgba(54, 162, 235, 0.5)'
    ],
    borderColors: [
      'rgb(255, 206, 86)',
      'rgb(255, 159, 64)',
      'rgb(255, 99, 132)',
      'rgb(54, 162, 235)'
    ]
  });

  // Initialize Moral Foundations Chart
  const moralData = <%= raw (full_profile&.dig(:extended_traits, :moral_foundations)&.slice(:care, :fairness, :loyalty, :authority, :purity) || {}).to_json %>;
  initializeRadarChart('moralFoundationsChart', moralData, 'Moral Foundations', {
    bgColor: 'rgba(255, 159, 64, 0.2)',
    borderColor: 'rgb(255, 159, 64)'
  });

  // Initialize Narrative Profile Chart
  const narrativeData = <%= raw (full_profile&.dig(:extended_traits, :narrative)&.slice(:immersion, :character_identification, :complexity_preference, :mental_imagery) || {}).to_json %>;
  initializeRadarChart('narrativeChart', narrativeData, 'Narrative Engagement', {
    bgColor: 'rgba(75, 192, 192, 0.2)',
    borderColor: 'rgb(75, 192, 192)'
  });

  // Initialize Psychological Needs Chart
  const psychData = <%= raw (full_profile&.dig(:extended_traits, :psychological_needs)&.slice(:autonomy, :competence, :relatedness, :escapism, :inspiration) || {}).to_json %>;
  initializeRadarChart('psychologicalChart', psychData, 'Psychological Needs', {
    bgColor: 'rgba(54, 162, 235, 0.2)',
    borderColor: 'rgb(54, 162, 235)'
  });

  // Initialize Dark Content Chart
  const darkData = <%= raw (full_profile&.dig(:extended_traits, :dark_triad)&.slice(:machiavellianism_appeal, :narcissism_appeal, :psychopathy_appeal) || {}).to_json %>;
  new Chart(document.getElementById('darkChart')?.getContext('2d'), {
    type: 'radar',
    data: {
      labels: Object.keys(darkData).map(key => key.replace('_appeal', '').split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')),
      datasets: [{
        label: 'Dark Triad Dimensions',
        data: Object.values(darkData),
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderColor: 'rgb(255, 99, 132)',
        pointBackgroundColor: 'rgb(255, 99, 132)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgb(255, 99, 132)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          angleLines: { display: true },
          suggestedMin: 0,
          suggestedMax: 100,
          ticks: {
            stepSize: 20
          }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });

  // Initialize HEXACO Chart
  const hexacoData = <%= raw (full_profile&.dig(:extended_traits, :hexaco, :honesty_humility)&.except(:overall) || {}).to_json %>;
  new Chart(document.getElementById('hexacoChart')?.getContext('2d'), {
    type: 'bar',
    data: {
      labels: Object.keys(hexacoData).map(trait => trait.charAt(0).toUpperCase() + trait.slice(1)),
      datasets: [{
        label: 'HEXACO Facets',
        data: Object.values(hexacoData),
        backgroundColor: 'rgba(26, 143, 227, 0.2)',
        borderColor: 'rgb(26, 143, 227)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            color: 'rgb(26, 143, 227)'
          },
          grid: {
            color: 'rgba(26, 143, 227, 0.1)'
          }
        },
        x: {
          ticks: {
            color: 'rgb(26, 143, 227)'
          },
          grid: {
            display: false
          }
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });

  // Initialize Attachment Style Chart
  const attachmentData = {
    anxiety: <%= raw full_profile&.dig(:extended_traits, :attachment_style, :anxiety) || 0 %>,
    avoidance: <%= raw full_profile&.dig(:extended_traits, :attachment_style, :avoidance) || 0 %>
  };
  new Chart(document.getElementById('attachmentStyleChart')?.getContext('2d'), {
    type: 'scatter',
    data: {
      datasets: [{
        label: 'Your Attachment Style',
        data: [{
          x: attachmentData.avoidance,
          y: attachmentData.anxiety
        }],
        backgroundColor: 'rgb(255, 99, 132)',
        borderColor: 'rgb(255, 99, 132)',
        pointRadius: 8,
        pointHoverRadius: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: {
            display: true,
            text: 'Avoidance'
          },
          min: 0,
          max: 100
        },
        y: {
          title: {
            display: true,
            text: 'Anxiety'
          },
          min: 0,
          max: 100
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });

  // Initialize Cognitive Profile Chart
  const cognitiveData = <%= raw (full_profile&.dig(:extended_traits, :cognitive)&.except(:primary_style) || {}).to_json %>;
  new Chart(document.getElementById('cognitiveChart')?.getContext('2d'), {
    type: 'radar',
    data: {
      labels: Object.keys(cognitiveData).map(value => value.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' vs ')),
      datasets: [{
        label: 'Cognitive Style',
        data: Object.values(cognitiveData).map(value => value.score),
        backgroundColor: 'rgba(153, 102, 255, 0.2)',
        borderColor: 'rgb(153, 102, 255)',
        pointBackgroundColor: 'rgb(153, 102, 255)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgb(153, 102, 255)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          angleLines: {
            display: true
          },
          suggestedMin: -100,
          suggestedMax: 100,
          ticks: {
            stepSize: 50
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const score = context.raw;
              const dimension = context.label.split(' vs ');
              return score < 0 ? 
                `${dimension[0]}: ${Math.abs(score)}%` : 
                `${dimension[1]}: ${score}%`;
            }
          }
        }
      }
    }
  });
});
</script>

<style>
  /* Custom styles for vertical tabs using our color palette */
  .nav-pills .nav-link {
    color: var(--bs-dark);
    background-color: var(--bs-light);
    border: 1px solid var(--bs-gray-300);
    margin-bottom: 0.5rem;
    padding: 0.75rem 1rem;
    transition: background-color 0.2s ease-in-out;
    font-weight: 500;
  }

  .nav-pills .nav-link:hover {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: var(--bs-white);
  }

  .nav-pills .nav-link.active {
    color: var(--bs-white);
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    box-shadow: 0 2px 4px rgba(var(--bs-primary-rgb), 0.25);
  }

  /* Simplified tab content area */
  .tab-content {
    background: transparent;
    border: none;
    padding: 0;
    box-shadow: none;
  }

  /* Improve visibility of icons in tabs */
  .nav-pills .nav-link i {
    opacity: 0.7;
  }

  .nav-pills .nav-link:hover i,
  .nav-pills .nav-link.active i {
    opacity: 1;
  }

  /* Remove transform effect */
  .nav-pills .nav-link:hover,
  .nav-pills .nav-link.active {
    transform: none;
  }
</style>
